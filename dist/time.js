!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash"),require("minno-sequencer")):"function"==typeof define&&define.amd?define(["lodash","minno-sequencer"],t):e["minno-time"]=t(e._,e.Database)}(this,function(v,u){"use strict";function e(t){var n=this.constructor;return this.then(function(e){return n.resolve(t()).then(function(){return e})},function(e){return n.resolve(t()).then(function(){return n.reject(e)})})}function t(n){return new this(function(o,e){if(!n||void 0===n.length)return e(new TypeError(typeof n+" "+n+" is not iterable(cannot read property Symbol(Symbol.iterator))"));var i=Array.prototype.slice.call(n);if(0===i.length)return o([]);var a=i.length;for(var t=0;t<i.length;t++)!function t(n,e){if(e&&("object"==typeof e||"function"==typeof e)){var r=e.then;if("function"==typeof r)return void r.call(e,function(e){t(n,e)},function(e){i[n]={status:"rejected",reason:e},0==--a&&o(i)})}i[n]={status:"fulfilled",value:e},0==--a&&o(i)}(t,i[t])})}v=v&&v.hasOwnProperty("default")?v.default:v,u=u&&u.hasOwnProperty("default")?u.default:u;var n=setTimeout;function c(e){return Boolean(e&&void 0!==e.length)}function r(){}function i(e){if(!(this instanceof i))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],f(e,this)}function o(n,r){for(;3===n._state;)n=n._value;0!==n._state?(n._handled=!0,i._immediateFn(function(){var e,t=1===n._state?r.onFulfilled:r.onRejected;if(null!==t){try{e=t(n._value)}catch(e){return void s(r.promise,e)}a(r.promise,e)}else(1===n._state?a:s)(r.promise,n._value)})):n._deferreds.push(r)}function a(t,e){try{if(e===t)throw new TypeError("A promise cannot be resolved with itself.");if(e&&("object"==typeof e||"function"==typeof e)){var n=e.then;if(e instanceof i)return t._state=3,t._value=e,void l(t);if("function"==typeof n)return void f((r=n,o=e,function(){r.apply(o,arguments)}),t)}t._state=1,t._value=e,l(t)}catch(e){s(t,e)}var r,o}function s(e,t){e._state=2,e._value=t,l(e)}function l(e){2===e._state&&0===e._deferreds.length&&i._immediateFn(function(){e._handled||i._unhandledRejectionFn(e._value)});for(var t=0,n=e._deferreds.length;t<n;t++)o(e,e._deferreds[t]);e._deferreds=null}function d(e,t,n){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=n}function f(e,t){var n=!1;try{e(function(e){n||(n=!0,a(t,e))},function(e){n||(n=!0,s(t,e))})}catch(e){if(n)return;n=!0,s(t,e)}}i.prototype.catch=function(e){return this.then(null,e)},i.prototype.then=function(e,t){var n=new this.constructor(r);return o(this,new d(e,t,n)),n},i.prototype.finally=e,i.all=function(t){return new i(function(o,i){if(!c(t))return i(new TypeError("Promise.all accepts an array"));var a=Array.prototype.slice.call(t);if(0===a.length)return o([]);var s=a.length;for(var e=0;e<a.length;e++)!function t(n,e){try{if(e&&("object"==typeof e||"function"==typeof e)){var r=e.then;if("function"==typeof r)return void r.call(e,function(e){t(n,e)},i)}a[n]=e,0==--s&&o(a)}catch(e){i(e)}}(e,a[e])})},i.allSettled=t,i.resolve=function(t){return t&&"object"==typeof t&&t.constructor===i?t:new i(function(e){e(t)})},i.reject=function(n){return new i(function(e,t){t(n)})},i.race=function(o){return new i(function(e,t){if(!c(o))return t(new TypeError("Promise.race accepts an array"));for(var n=0,r=o.length;n<r;n++)i.resolve(o[n]).then(e,t)})},i._immediateFn="function"==typeof setImmediate?function(e){setImmediate(e)}:function(e){n(e,0)},i._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)};var m,h,p,g,w=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}();function y(){console.log.apply(console,arguments)}"function"!=typeof w.Promise?w.Promise=i:w.Promise.prototype.finally?w.Promise.allSettled||(w.Promise.allSettled=t):w.Promise.prototype.finally=e,function(e){var t,n=["now","webkitNow","msNow","mozNow"];if(e.performance)for(var r=0;r<n.length;++r){var o=n[r];if(e.performance[o]){t=function(){return e.performance[o]()};break}}t=t||Date.now,e.perfNow=t}(window),console.group||(console.group=y),console.groupCollapsed||(console.groupCollapsed=y),console.groupEnd||(console.groupEnd=y),console.table||(console.table=y),function(){for(var r,e=["webkit","moz"],t=0;t<e.length&&!window.requestAnimationFrame;++t){var n=e[t];window.requestAnimationFrame=window[n+"RequestAnimationFrame"],window.cancelAnimationFrame=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"]}!/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent)&&window.requestAnimationFrame&&window.cancelAnimationFrame||(r=0,window.requestAnimationFrame=function(e){var t=Date.now(),n=Math.max(r+16,t);return setTimeout(function(){e(r=n)},n-t)},window.cancelAnimationFrame=clearTimeout)}(),Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector),Element.prototype.closest||(Element.prototype.closest=function(e){var t=this;do{if(Element.prototype.matches.call(t,e))return t}while(null!==(t=t.parentElement||t.parentNode)&&1===t.nodeType);return null}),m=".minno-canvas{height:400px;width:500px;position:relative;border:5px solid #fff;margin:10px auto auto;-webkit-text-size-adjust:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;display:flex;justify-content:center;align-items:center}.minno-stimulus{position:absolute;text-align:center;overflow:hidden;visibility:hidden;width:auto;height:auto;max-width:100%}.minno-stimulus-visible{visibility:visible}.minno-progress{background-color:#20201f;border-radius:20px;padding:4px;position:absolute;top:50%;left:10%;width:80%;height:24px;margin-top:-12px}.minno-progress-bar{background-color:#807b7a;width:0;height:16px;border-radius:10px}",g=(h=void 0===(h={})?{}:h).insertAt,m&&"undefined"!=typeof document&&(p=document.head||document.getElementsByTagName("head")[0],(h=document.createElement("style")).type="text/css","top"===g&&p.firstChild?p.insertBefore(h,p.firstChild):p.appendChild(h),h.styleSheet?h.styleSheet.cssText=m:h.appendChild(document.createTextNode(m)));var b=window.piGlobal||(window.piGlobal={});function E(e,t,n){var r=this.mixerSequence;switch(e){case"nextWhere":_("next",t,n,r);break;case"previousWhere":_("prev",t,n,r);break;case"current":break;case"first":for(;r.prev(n),r.current(n););break;case"last":for(;r.next(n),r.current(n););r.prev();break;case"end":for(;r.next(n),r.current(n););break;case"next":r.next(n);break;default:throw new Error('Unknow destination "'+e+'" for goto.')}return this}function _(e,t,n,r){for(var o;r[e](),o=r.current(n),o&&!v.iteratee(t)(o.data););}var x="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function k(e,t){return e(t={exports:{}},t.exports),t.exports}var q=k(function(s){!function(e){var o=function(){},t=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.msRequestAnimationFrame||function(e){return setTimeout(e,16)};function n(){this.reads=[],this.writes=[],this.raf=t.bind(e)}function i(e){e.scheduled||(e.scheduled=!0,e.raf(function(e){var t,n=e.writes,r=e.reads;try{o("flushing reads",r.length),e.runTasks(r),o("flushing writes",n.length),e.runTasks(n)}catch(e){t=e}e.scheduled=!1,(r.length||n.length)&&i(e);if(t){if(o("task errored",t.message),!e.catch)throw t;e.catch(t)}}.bind(null,e)))}function r(e,t){t=e.indexOf(t);return!!~t&&!!e.splice(t,1)}n.prototype={constructor:n,runTasks:function(e){for(var t;t=e.shift();)t()},measure:function(e,t){e=t?e.bind(t):e;return this.reads.push(e),i(this),e},mutate:function(e,t){e=t?e.bind(t):e;return this.writes.push(e),i(this),e},clear:function(e){return r(this.reads,e)||r(this.writes,e)},extend:function(e){if("object"!=typeof e)throw new Error("expected object");var t=Object.create(this);return function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}(t,e),t.fastdom=this,t.initialize&&t.initialize(),t},catch:null};var a=e.fastdom=e.fastdom||new n;s.exports=a}("undefined"!=typeof window?window:x)});function P(e){return parseFloat(e,10)||0}function T(n,r,i){return v.throttle(function(e){"orientationchange"==e.type?setTimeout(t,500):t()},16);function t(){q.measure(function(){var e=function(e,t){var n=function(e){var t=e.proportions;if(C(t))return t;if(v.isPlainObject(t)){if([t.height,t.width].every(C))return t.height/t.width;i({type:"warn",message:"minno settings.canvas.proportions.width and settings.canvas.proportions.height must both be numeric",context:e})}t&&i({type:"warn",message:"minno settings.canvas.proportions must be either numeric or a plain object",context:e});return.8}(e);if(e.width)return C(e.width)||i({type:"warn",message:"minno settings.canvas.width must be numeric",context:e}),{width:e.width,height:e.width*n};e.maWidth&&!C(e.maxWidth)&&i({type:"warn",message:"minno settings.canvas.maxWidth must be numeric",context:e});var r=window.document.documentElement,o=r.clientHeight,t=Math.min(e.maxWidth||1/0,r.clientWidth,function(e){var t=window.getComputedStyle(e);return{height:P(e.offsetHeight)-P(t.borderTopWidth)-P(t.borderBottomWidth),width:P(e.offsetWidth)-P(t.borderLeftWidth)-P(t.borderRightWidth)}}(t.parentNode).width);return n*t<o?{height:t*n,width:t}:{height:o,width:o/n}}(r,n),t=window.getComputedStyle(n);e.height-=A(t.borderTopWidth)+A(t.borderBottomWidth)+A(t.marginTop),e.width-=A(t.borderLeftWidth)+A(t.borderRightWidth),q.mutate(function(){n.style.width=e.width+"px",n.style.height=e.height+"px",n.style.fontSize=e.height*(r.textSize||3)/100+"px",window.scrollTo(0,1)})})}}function A(e){return parseFloat(e,10)||0}function C(e){return!isNaN(parseFloat(e))&&isFinite(e)}function S(a,e){var t;if(!v.isPlainObject(a))throw new Error("canvas(map): You must set a rule map for canvas to work properly");if(v.isUndefined(e))return v.noop;if(!v.isPlainObject(e))throw new Error("canvas(settings): canvas settings must be an object");return t=v.map(e,function(e,t){var n,r,o,i=a[t];if(i)return n=i.element,r=i.property,e=e,o=n.style[r],n.style[r]=e,function(){n.style[r]=o};throw new Error("canvas("+t+"): unknow key in canvas object.")}),function(){v.forEach(t,function(e){e.call()})}}var F=k(function(e){function a(){function e(){return 0<arguments.length&&arguments[0]!==g&&t(e,arguments[0]),e._state.value}var n;return(n=e).constructor=a,n._state={id:v++,value:void 0,state:0,derive:void 0,recover:void 0,deps:{},parents:[],endStream:void 0,unregister:void 0},n.map=n["fantasy-land/map"]=u,n["fantasy-land/ap"]=c,n["fantasy-land/of"]=a,n.valueOf=l,n.toJSON=d,n.toString=l,Object.defineProperties(n,{end:{get:function(){var t;return n._state.endStream||((t=a()).map(function(e){return!0===e&&(o(n),t._state.unregister=function(){o(t)}),e}),n._state.endStream=t),n._state.endStream}}}),0<arguments.length&&arguments[0]!==g&&t(e,arguments[0]),e}function t(e,t){for(var n in r(e,t),e._state.deps)s(e._state.deps[n],!1);null!=e._state.unregister&&e._state.unregister(),function(e){for(var t in e._state.changed=!1,e._state.deps)e._state.deps[t]._state.changed=!1}(e)}function r(e,t){e._state.value=t,e._state.changed=!0,2!==e._state.state&&(e._state.state=1)}function s(e,t){var n=e._state.parents;0<n.length&&n.every(m)&&(t||n.some(h))&&((n=e._state.derive())!==g&&r(e,n))}function i(e,t){if(!t.every(f))throw new Error("Ensure that each item passed to stream.combine/stream.merge is a stream");return n=a(),r=t,o=function(){return e.apply(this,t.concat([t.filter(h)]))},(i=n._state).derive=o,i.parents=r.filter(p),function e(t,n){for(var r=0;r<n.length;r++)n[r]._state.deps[t._state.id]=t,e(t,n[r]._state.parents)}(n,i.parents),s(n,!0),n;var n,r,o,i}function o(e){for(var t,n=0;n<e._state.parents.length;n++)delete e._state.parents[n]._state.deps[e._state.id];for(t in e._state.deps){var r=e._state.deps[t],o=r._state.parents.indexOf(e);-1<o&&r._state.parents.splice(o,1)}e._state.state=2,e._state.deps={}}function u(t){return i(function(e){return t(e())},[this])}function c(e){return i(function(e,t){return e()(t())},[e,this])}function l(){return this._state.value}function d(){return null!=this._state.value&&"function"==typeof this._state.value.toJSON?this._state.value.toJSON():this._state.value}function f(e){return e._state}function m(e){return 1===e._state.state}function h(e){return e._state.changed}function p(e){return 2!==e._state.state}var v,g;v=0,g={},(a["fantasy-land/of"]=a).merge=function(e){return i(function(){return e.map(function(e){return e()})},e)},a.combine=i,a.scan=function(t,n,e){return 0===(e=i(function(e){return n=t(n,e._state.value)},[e]))._state.state&&e(n),e},a.scanMerge=function(r,o){var e=r.map(function(e){e=e[0];return 0===e._state.state&&e(void 0),e});return i(function(){var n=arguments[arguments.length-1];return e.forEach(function(e,t){-1<n.indexOf(e)&&(o=r[t][1](o,e._state.value))}),o},e)},a.HALT=g,e.exports=a}),j=function(e,t){var n,r=e.style;if(!t)return;for(n in t)r[function(e){return e.replace(/-([a-z])/g,function(e){return e[1].toUpperCase()})}(n)]=t[n]};function $(e,t){var n,r,o,i=F(),a=function(e,t,n){t=t||{};var r=F();if(!v.isElement(e))throw new Error("minno-time: canvas is not a DOM element");e.classList.add("minno-canvas");var o=S({background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:e,property:"backgroundColor"},borderColor:{element:e,property:"borderColor"},borderWidth:{element:e,property:"borderWidth"}},v.pick(t,["background","canvasBackground","borderColor","borderWidth"]));return t.css&&j(e,t.css),r.map(T(e,t,n)),r({}),window.addEventListener("orientationchange",r),window.addEventListener("resize",r),r.end.map(function(){e.classList.remove("minno-canvas")}).map(function(){window.removeEventListener("orientationchange",r),window.removeEventListener("resize",r)}).map(o),r}(e,v.get(t,"settings.canvas",{}),i),s=function(e){var t=new u;if(t.createColl("trial"),t.createColl("stimulus"),t.createColl("media"),t.add("trial",e.trialSets||[]),t.add("stimulus",e.stimulusSets||[]),t.add("media",e.mediaSets||[]),!v.isArray(e.sequence))throw new Error("You must set a sequence array.");return(e=t.sequence("trial",e.sequence)).go=E,t.currentSequence=e,t}(t);return r=b,o=(n=t).name||"anonymous minno-time",(n=n.current||{}).logs||(n.logs=[]),r[o]=r.current=n,{db:s,$resize:a,$messages:i,canvas:e,script:t,settings:t.settings||{}}}var L=[],M=[],O=0,N=v.memoize(function(r){return new Promise(function(e,t){var n=new XMLHttpRequest;n.open("GET",r,!0),n.onreadystatechange=function(){4===this.readyState&&(200<=this.status&&this.status<400?e(this.responseText):t(new Error("Template not found:"+r)))},n.send()})}),W={load:function(t,e){if(-1!==L.indexOf(t))return!1;e=("template"==e?N:function(r){return new Promise(function(e,t){if(v.includes(r,"<%"))return e();var n=document.createElement("img");n.onload=e,n.onerror=function(){t(new Error("Image not found: "+r))},n.src=r})})(t);return e.then(function(){O++}).then(function(){W.onload&&W.onload(t)}).catch(function(e){W.onerror&&W.onerror(e,t)}),M.push(e),L.push(t),e},all:function(){return Promise.all(M)},progress:function(){return M.length?O/M.length:1}};function z(e,t,n){return"image"==n&&/^data:image/.test(t)?t:((e=v.isObject(e)?e[n]:e)?"/"!=e[e.length-1]&&(e+="/"):e="",e+t)}function I(e,t){var n,r,o,i;return r=(n=e).mediaSets,o=v.map(n.stimulusSets,U),i=v.map(n.trialSets,D),e=v.filter(n.sequence,R).map(D),n=v.get(n.settings,"preloadImages",[]).map(function(e){return{image:e}}),v.flattenDeep([r,o,i,e,n]).filter(B).forEach(function(e){v.isUndefined(e.image)||W.load(z(t,e.image,"image"),"image");v.isUndefined(e.template)||W.load(z(t,e.template,"template"),"template")}),W}function D(e){return[v.map(e.input,function(e){return e.element}),v.map(e.stimuli,U),v.map(e.layout,U)]}function U(e){return e.media}function R(e){return!e.mixer}function B(e){return!v.isUndefined(e)}function H(e,n,t){var r=F(),o=n.element;return o&&(j(o,n.css),q.mutate(function(){t.appendChild(o)})),t.addEventListener(e,function(e){var t=e.target;return o&&o.contains(t)||!o&&t.closest('[data-handle="'+n.stimHandle+'"]')?r(e):void 0}),r.end.map(function(){o&&t.removeChild(o);t.removeEventListener(e,r)}),r}var G=[];function J(e){var t=F(),n=(Array.isArray(e.key)?e.key:[e.key]).map(function(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e});return document.addEventListener("keydown",r),t.end.map(function(){document.removeEventListener("keydown",r)}),t;function r(e){G[e.which]||-1===n.indexOf(e.which)||(e.preventDefault(),G[e.which]=!0,t(e))}}function Y(e){var t=F(),n=(Array.isArray(e.key)?e.key:[e.key]).map(function(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e});return document.addEventListener("keyup",function(e){return-1===n.indexOf(e.which)?void 0:(e.preventDefault(),t(e))}),t.end.map(function(){document.removeEventListener("keyup",t)}),t}document.addEventListener("keyup",function(e){G[e.which]=!1});var X,V,K,Q,Z=window.performance.now?window.performance.now.bind(window.performance):Date.now.bind(Date),ee=5;function te(e){var n=F(),r=function(e,t){if(v.isArray(e))return e[Math.floor(Math.random()*e.length)];if(v.isFunction(e))return e.call(t);if(v.isPlainObject(e)){if(!v.isNumber(e.min)||!v.isNumber(e.max)||e.min>e.max)throw new Error("randomization objects need both a max and a minimum property, also max has to be larger than min");return e.min+(e.max-e.min)*Math.random()}return e}(e.duration)||0,o=!1;return n.end.map(function(){o=!0}),r?q.measure(function(){var t=Z()+ +r-ee;!function e(){if(o)return;q.measure(function(){Z()>=t?n({}):q.mutate(e)})}()}):n({}),n}function ne(){requestAnimationFrame(function(){return V=Z(),Q.push(V-X),X=V,Q.length<K?setTimeout(ne):void(ee=(e=Q).reduce(function(e,t){return e+t},0)/e.length/3);var e})}function re(e,t){var n=function(e,t){if(v.isFunction(e))return e(e,t,F);if(v.isPlainObject(e)){if(v.isString(e.on))return function(e,t){var n=e.on;switch(n){case"keypressed":return J(e);case"keyup":return Y(e);case"click":case"mousedown":return H("mousedown",e,t);case"mouseup":return H("mouseup",e,t);case"mouseover":return H("mouseover",e,t);case"mouseout":return H("mouseout",e,t);case"timeout":return te(e);case"enter":return J(v.assign({key:13},e));case"space":return J(v.assign({key:32},e));case"esc":return J(v.assign({key:27},e));case"leftTouch":return e.element=r(e.css,{position:"absolute",left:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),H("mousedown",e,t);case"rightTouch":return e.element=r(e.css,{position:"absolute",right:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),H("mousedown",e,t);case"topTouch":return e.element=r(e.css,{position:"absolute",top:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),H("mousedown",e,t);case"bottomTouch":return e.element=r(e.css,{position:"absolute",bottom:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),H("mousedown",e,t);default:throw new Error('You have an input element with an unrecognized "on" property: '+n)}function r(e,t){var n=document.createElement("div");return j(n,t),j(n,e),n}}(e,t);if(v.isFunction(e.on)){if(!(t=e.on(e,t,F))||!t._state)throw new Error("input.on must return a stream");return v.isFunction(e.off)&&t.end.map(e.off),t}}throw new Error("Input must only contain objects and functions, do you have an undefined value?")}(e,t);if(!n._state)throw new Error("Input functions must return valid streams: "+(t=e,v.isFunction(t)?t.toString():JSON.stringify(t)));return"handle"in e&&(n.handle=e.handle),n}function oe(n,r){var o=[],i=0;return{add:function(e){if(!e)throw new Error("Missing input element. Could not add input listener");var t=re(e,r);t.map(function(e){return{handle:t.handle,event:e,timestamp:+new Date,latency:Z()-i}}).map(n),o.push(t)},remove:function(e){for(var t=o.length-1;0<=t;t--){var n=o[t];n.handle===e&&(n.end(!0),o.splice(t,1))}},removeAll:function(){o.forEach(function(e){e.end(!0)}),o.length=0},resetTimer:function(){i=Z()}}}function ie(o,i){var a,e=o.html||o.inlineTemplate||o.template;return v.isFunction(o)?function(e){e=e();return function(e){return e&&v.isFunction(e.then)}(e)?e.then(function(e){return v.isElement(e)?e:Promise.reject("Custom media must resolve with an element")}):Promise.reject(new Error("Custom media must return a promise"))}(o):(ae(o)&&(o={word:o}),ae(o.word)?((a=document.createElement("div")).textContent=o.word,Promise.resolve(a)):e?((a=document.createElement("div")).innerHTML=e,Promise.resolve(a)):o.$image?new Promise(function(t,e){var n=performance.now(),r=o.$image;(a=document.createElement("img")).onload=function(){var e=performance.now()-n;16<e&&i({type:"warn",message:'It took too long to load "'+r+'" ('+e+"ms). Make sure that it was preloaded properly.",context:r}),t(a)},a.onerror=function(){e(new Error("Image not found: "+a.src))},a.src=r}):o.jquery?Promise.reject(new Error("Jquery is no longer supported in minno-time")):Promise.reject(new Error("Unrecognized media type")))}function ae(e){return v.isString(e)||v.isNumber(e)}function se(e,t){var n=e.style,r=t.size||{};return r.font_size&&(n.fontSize=r.font_size),"height"in r&&(t=t.media,!v.isString(t)&&!v.isString(t.word))&&(n.height=r.height+"%"),"width"in r&&(n.width=r.width+"%"),e}function ue(t,e){var n=e.location||{};["top","bottom","left","right"].forEach(function(e){!function(e){return!isNaN(+e)}(n[e])||(t.style[e]=n[e]+"%")})}K=50,Q=[],requestAnimationFrame(function(){X=Z(),ne()});var ce=window.document.documentMode;function le(n,u,c){var l=n.canvas;return n.el=c,new Promise(function(t){q.mutate(function(){function r(e,t){return"center"===e||"center"===t||void 0===e&&void 0===t}var o,i,e,a,s;c.classList.add("minno-stimulus"),c.setAttribute("data-handle",n.handle),c.style.zIndex=10*u,l.appendChild(c),se(c,n.source),ue(c,n.source),j(c,n.source.css||{}),ce?(i=t,e=(o=n).canvas,a=o.el,s=o.source.location||{},q.measure(function(){var t=100*a.clientWidth/e.clientWidth,n=100*a.clientHeight/e.clientHeight;q.mutate(function(){var e=a.style;e.width=t+"%",e.height=n+"%",r(s.top,s.bottom)&&(e.top=(100-n)/2+"%"),r(s.left,s.right)&&(e.left=(100-t)/2+"%"),o.source.isLayout&&a.classList.add("minno-stimulus-visible"),i(a)})})):(n.source.isLayout&&c.classList.add("minno-stimulus-visible"),t(c))})})}function de(e){var t=this.source,n=this.trial.$messages;if(!this.source.media)throw new Error("Media object not defined for "+this.name());return ie(this.source.media,n).then(le.bind(null,this,e)).catch(function(e){throw n({type:"error",message:"trial.stimulus error",error:e,context:t}),e})}function fe(){var e=this.el;if(!e)throw new Error("A stimulus can not be shown before init is called");q.mutate(function(){e.classList.add("minno-stimulus-visible")})}function me(){var e=this.el;if(!e)throw new Error("A stimulus can not be hidden before init is called");q.mutate(function(){e.classList.remove("minno-stimulus-visible")})}function he(){var e=this.el,t=this.canvas;q.mutate(function(){t.removeChild(e)})}function pe(){var e=this.source;return e.alias||(this.data&&this.data.alias?this.data.alias:e.inherit&&e.inherit.set?e.inherit.set:this.handle||void 0)}function ve(e){var t,n=this.source.media,r=e&&e.fullpath;if(n.alias)return n.alias;if(n.data&&n.data.alias)return n.data.alias;for(t in n){if(ge(["image","template"],t))return r?n[t]:n[t].replace(/^.*[\\/]/,"");if(ge(["word","html","inlineTemplate"],t)&&n[t])return n[t]}}function ge(e,t){return-1!=e.indexOf(t)}function we(n,r){_e("stimuli",n._source),_e("layout",n._source);var e=n._source,t=v.map(e.stimuli,i),o=v.map(e.layout,function(e){return e.isLayout=!0,e}).map(i),e=t.concat(o).map(function(e,t){return e.init(t)});return{canvas:r,stimuli:t,layout:o,ready:Promise.all(e),getStimlist:ye,getMedialist:be,destroy:Ee};function i(e){return(e={el:null,source:t=e,trial:n,canvas:e=r,init:de,show:fe,hide:me,name:pe,mediaName:ve,destroy:he}).data=t.data||{},e.handle=e.data.handle=e.data.handle||t.handle||t.set,e;var t}}function ye(){return this.stimuli.filter(function(e){return!e.source.nolog}).map(function(e,t){return e.name()||"stim"+t})}function be(n){return this.stimuli.filter(function(e){return!e.source.nolog}).map(function(e,t){return e.mediaName(n)||"media"+t})}function Ee(){this.stimuli.concat(this.layout).forEach(function(e){e.destroy()})}function _e(e,t){t=t[e];if(t){if(!Array.isArray(t))throw new Error(e+" must be an array");if(!t.every(function(e){return"media"in e}))throw new Error("Each "+e+" stimulus must have a media property")}}var xe=b,ke={begin:function(e){return"begin"===e.type},inputEquals:function(e,t){return-1!==(Array.isArray(t.value)?t.value:[t.value]).indexOf(e.handle)},inputEqualsTrial:function(e,t,n){return e.handle===n.data[t.property]},inputEqualsStim:function(e,t,n){var r={};t.handle&&(r.handle=t.handle);return r[t.property]=e.handle,qe(r,n)},trialEquals:function(e,t,n){if(v.isUndefined(t.property)||v.isUndefined(t.value))throw new Error('trialEquals requires both "property" and "value" to be defined');return t.value===n.data[t.property]},inputEqualsGlobal:function(e,t){if(v.isUndefined(t.property))throw new Error('inputEqualsGlobal requires "property" to be defined');return e.handle===xe[t.property]},globalEquals:function(e,t){if(void 0===t.property||void 0===t.value)throw new Error('globalEquals requires both "property" and "value" to be defined');return t.value===xe[t.property]},globalEqualsTrial:function(e,t,n){if(void 0===t.globalProp||void 0===t.trialProp)throw new Error('globalEqualsTrial requires both "globalProp" and "trialProp" to be defined');return xe[t.globalProp]===n.data[t.trialProp]},globalEqualsStim:function(e,t,n){if(void 0===t.globalProp||void 0===t.stimProp)throw new Error('globalEqualsStim requires both "globalProp" and "stimProp" to be defined');var r={};t.handle&&(r.handle=t.handle);return r[t.stimProp]=xe[t.globalProp],qe(r,n)},currentEquals:function(e,t){var n=xe.current;if(void 0===t.property||void 0===t.value)throw new Error('currentEquals requires both "property" and "value" to be defined');return t.value===n[t.property]},currentEqualsTrial:function(e,t,n){var r=xe.current;if(void 0===t.currentProp||void 0===t.trialProp)throw new Error('currentEqualsTrial requires both "currentProp" and "trialProp" to be defined');return r[t.currentProp]===n.data[t.trialProp]},currentEqualsStim:function(e,t,n){var r=xe.current;if(void 0===t.currentProp||void 0===t.stimProp)throw new Error('currentEqualsStim requires both "currentProp" and "stimProp" to be defined');var o={};t.handle&&(o.handle=t.handle);return o[t.stimProp]=r[t.currentProp],qe(o,n)},inputEqualsCurrent:function(e,t){var n=xe.current;if(void 0===t.property)throw new Error('inputEqualsCurrent requires "property" to be defined');return e.handle===n[t.property]},fn:function(e,t,n){return t.value.apply(n,[t,e,n])},custom:function(e,t,n){return t.fn.apply(null,[t,e,n])}};function qe(r,e){return e.stimulusCollection.stimuli.some(function(e){var t,n=e.data;for(t in r)if(r[t]!==n[t])return!1;return!0})}function Pe(e,n,r){return!!(e=Array.isArray(e)?e:[e]).length&&(("begin"!=n.type||!e.every(function(e){return"begin"!=e.type}))&&e.every(function(e){var t=function(e){if(v.isFunction(e))return e;if(v.isFunction(ke[e.type]))return ke[e.type];throw new Error("Unknown condition type: "+JSON.stringify(e))}(e)(n,e,r);return e.negate?!t:t}))}var Te={showStim:function(e,t,n){var r=e.handle||e;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||e.show()})},hideStim:function(e,t,n){var r=e.handle||e;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||e.hide()})},setStimAttr:function(e,t,n){var r=e.handle,o=e.setter;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||(v.isFunction(o)?o.apply(e):v.extend(e.data,o))})},setTrialAttr:function(e,t,n){e=e.setter;if(void 0===e)throw new Error("The setTrialAttr action requires a setter property");v.isFunction(e)?e.apply(n,[n.data,t]):v.extend(n.data,e)},setInput:function(e,t,n){if(void 0===e.input)throw new Error("The setInput action requires an input property");n.input.add(e.input)},trigger:function(e,t,n){if(void 0===e.handle)throw new Error("The trigger action requires a handle property");n.input.add({handle:e.handle,on:"timeout",duration:+e.duration||0})},removeInput:function(e,t,n){n=n.input,e=e.handle;if(void 0===e)throw new Error("The removeInput action requires a handle property");Array.isArray(e)||(e=[e]),v.includes(e,"All")?n.removeAll():e.forEach(n.remove)},goto:function(e,t,n){n._next=[e.destination,e.properties]},endTrial:function(){},resetTimer:function(e,t,n){function r(){t.latency=0,n.input.resetTimer()}e.immidiate?r():q.mutate(r)},log:function(e,t,n){n.$logs(arguments)},setGlobalAttr:function(e){switch(typeof e.setter){case"function":e.setter.apply(null,[b,e]);break;case"object":v.extend(b,e.setter);break;default:throw new Error('setGlobalAttr requires a "setter" property')}},custom:function(e,t,n){if("function"!=typeof e.fn)throw new Error("The custom action requires a fn propery");e.fn(e,t,n)},canvas:function(e,t,n){var r=n.cavnas,e=S({background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:r,property:"backgroundColor"},borderColor:{element:r,property:"borderColor"},borderWidth:{element:r,property:"borderWidth"}},v.pick(e,["background","canvasBackground","borderColor","borderWidth"]));n.$end.map(e)},startMouseTracking:function(t,e,n){if(n.data.listener)return n.$message({type:"warn",message:"Mouse tracking has already been activated."});var i=performance.now(),a=n.canvas,s=t.logAs||"mousetracker",r=getComputedStyle(a),u=parseInt(r.getPropertyValue("border-top-width")),c=parseInt(r.getPropertyValue("border-left-width")),l=n.stimulusCollection.stimuli.filter(function(e){return v.includes(t.logStimulusLocation,e.handle)}),o=v.throttle(function(e){var t=a.getBoundingClientRect(),r=t.x+c,o=t.y+u,e={mouseX:e.clientX-r,mouseY:e.clientY-o},e=l.reduce(function(e,t){var n=t.el.getBoundingClientRect();return v.set(e,t.handle+"X",n.x-r),v.set(e,t.handle+"Y",n.y-o),v.set(e,t.handle+"Width",n.width),v.set(e,t.handle+"Height",n.height),e},e),e=v.mapValues(v.set(e,"time",performance.now()-i),Math.round);n.data[s].push(e)},t.logRate||15);n.data[s]||(n.data[s]=[]),n.data.$listener=o,document.addEventListener("mousemove",o),n.$events.end.map(function(){document.removeEventListener("mousemove",o)})},stopMouseTracking:function(e,t,n){v.isFunction(n.data.$listener)&&(document.removeEventListener("mousemove",n.data.$listener),n.data.$listener=void 0)}};function Ae(s){var u=0,c=s._source.interactions;try{!function(e){if(!Array.isArray(e))throw new Error("Interactions must be an array");if(!e.length)throw new Error("There are no interactions defined");if(!e.every(v.isPlainObject))throw new Error("Interactions must be plain objects");if(!e.every(t("conditions")))throw new Error("Conditions must be either an array or a function");if(!e.every(t("actions")))throw new Error("Actions must be either an array or a function");function t(t){return function(e){return Array.isArray(e[t])||v.isFunction(e[t])}}}(c)}catch(e){throw s.$messages({type:"error",message:"trial.interactions error",error:e,context:s._source}),e}return function(e){var t,n,r,o,i="Event: "+(e.handle||e.type),a=[];if(50<u)throw new Error("It seem you have created an infinite loop. Minno has been halted");u++;try{for(t=0;t<c.length&&(n=c[t],r=Pe(n.conditions,e,s),a.push([r,n.conditions]),!(o=r?function(e,n,r){var o=!1;return e=v.isArray(e)?e:[e],v.forEach(e,function(e){var t=v.isFunction(e)?e:Te[e.type];if(!t)throw new Error("unknown action: "+e.type);"endTrial"===e.type&&(o=!0),t(e,n,r)}),o}(n.actions,e,s):o));t++);}catch(e){throw s.$messages({type:"error",message:"trial.interactions error",error:e}),e}u--,s.$messages({type:"debug",message:i,rows:a}),o&&s.end();return e}}var Ce=0;function Se(e,t,n){if(!e.interactions)throw new Error("Interactions not defined");this.canvas=t,this.settings=n,this._source=e,this.$logs=F(),this.$messages=F(),this.$events=F(),this.$end=this.$events.end,this.data=e.data||{},this._id=v.uniqueId("trial_"),this.counter=Ce++,this.input=oe(this.$events,t),this.stimulusCollection=we(this,t),this._next=["next",{}]}function Fe(e,t,n){var r=window.piGlobal,o=n.data,i=t,a=r.current.logs,t=v.get(n,"settings.logger.fullpath",!1),r=n.stimulusCollection.getStimlist(),t=n.stimulusCollection.getMedialist({fullpath:t});return{log_serial:a.length,trial_id:n.counter,name:n.name(),responseHandle:i.handle,latency:Math.floor(i.latency),stimuli:r,media:t,data:o}}function je(r){var o,e,t,n,i,u,a=r.canvas,c=r.db,l=r.settings,s=b,d=F(),f=d.map(function(e){var t=o,n=o=new Se(e,a,l);n.$logs.map(m),n.$messages.map(r.$messages),e.DEBUG&&window.DEBUG&&function(e){var t="Trial :"+e.counter;console.group(t),e.$messages.map(function(e){return"debug"!==e.type||(e.rows?(console.groupCollapsed(e.message),e.rows.forEach(function(e){console.log.apply(console,e)}),console.groupEnd(e.message)):console.log(e.message)),e}),e.$events.end.map(function(){console.groupEnd(t)})}(n);n.$end.map(function(){p(n._next)}),n.start(),t&&n.stimulusCollection.ready.then(function(){t.stimulusCollection.destroy()});return n}),m=F(),e=(e=m,n=r.script,h=s,i=v.assign({},v.get(n,"settings.logger")),h=v.assign({taskName:n.name},h.$meta,i.metaData),i.metaData=h,h=Fe,h=(i=i).logger||i.logMap||h,e.map((t=h,function(e){return t.apply(null,e)}))),h=v.get(l,"hooks.endTask",l.onEnd||v.noop),h=new Promise(function(e){u=e}).then(d.end.bind(null,!0)).then(function(){var e=f();e&&e.stimulusCollection.destroy()}).then(h);return e.map(function(e){s.current.logs.push(e)}),d.end.map(f.end).map(m.end),v.extend({$trial:f,$logs:e,start:p.bind(null,["next",{}]),end:u,promise:h},r);function p(e){var o,i,t,n,r,e=(o=c,i=l,n=(t=e)[0],r=t[1],e=o.currentSequence,t={global:b,current:b.current},e.go(n,r,t),e=e.current(t,{skip:["layout","stimuli"]}),(e=v.clone(e))?(t.trialData=e.data,t.trialMeta=e.$meta,e.stimuli=v.map(e.stimuli||[],s.bind(t)),e.layout=v.map(e.layout||[],s.bind(t)),{value:e}):{done:!0});function a(e,t,n){var r=e[t];v.isUndefined(r)||((v.isString(r)||v.isNumber(r))&&(r={word:r}),(r=o.inflate("media",r,n)).image&&(r.$image=z(i.base_url,r.image,"image")),r.template&&(r.inlineTemplate=requirejs("text!"+z(i.base_url,r.template,"template")),r.inlineTemplate=v.template(r.inlineTemplate)(n)),e[t]=r,n.mediaData=null,n.mediaMeta=null)}function s(e){var t=this;return e=o.inflate("stimulus",e,t,{skip:["media","touchMedia"]}),a(e=v.clone(e),"media",t),a(e,"touchMedia",t),t.stimulusData=null,t.stimulusMeta=null,e}e.done?u():d(e.value)}}return v.extend(Se.prototype,{start:function(){var e=this;return e.stimulusCollection.ready.then(function(){var t;e.$events.map((t=e,function(e){return v.assign(e,{trialId:t._id,counter:t.counter})})).map(Ae(e)),v.forEach(e._source.input,e.input.add),fastdom.mutate(function(){e.input.resetTimer()}),e.$events({type:"begin",latency:0})})},end:function(){this.input.removeAll(),this.$end(!0)},name:function(){return this.alias||this.data.alias||(v.isString(this._source.inherit)?this._source.inherit:v.isPlainObject(this._source.inherit)?this._source.inherit.set:void 0)}}),function(e,t){var n=je($(e,t));return n.$trial.end.map(n.$resize.end),function(e,t,n){var r=I(t,t.settings.base_url);if(1==r.progress())return Promise.resolve().then(i);e.innerHTML='<div class="minno-progress"><div class="minno-progress-bar"></div></div>';var o=e.getElementsByClassName("minno-progress-bar")[0].style;return o.width=r.progress()+"%",r.onload=function(){q.mutate(function(){o.width=100*r.progress()+"%"})},r.onerror=function(e,t){n({type:"error",message:"Failed to preload",error:e,context:t})},r.all().then(i).catch(function(e){throw new Error("loading resource failed, do something about it! (you can start by checking the error log, you are probably reffering to the wrong url - "+e+")")});function i(){for(;e.firstChild;)e.removeChild(e.firstChild)}}(e,t,n.$messages).then(n.start),n}});
//# sourceMappingURL=time.js.map
