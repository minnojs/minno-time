!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash"),require("minno-sequencer")):"function"==typeof define&&define.amd?define(["lodash","minno-sequencer"],t):e["minno-time"]=t(e._,e.Database)}(this,function(v,u){"use strict";function e(){console.log.apply(console,arguments)}var t,n,r,i;v=v&&v.hasOwnProperty("default")?v.default:v,u=u&&u.hasOwnProperty("default")?u.default:u,function(e){var t,n=["now","webkitNow","msNow","mozNow"];if(e.performance)for(var r=0;r<n.length;++r){var i=n[r];if(e.performance[i]){t=function(){return e.performance[i]()};break}}t=t||Date.now,e.perfNow=t}(window),console.group||(console.group=e),console.groupCollapsed||(console.groupCollapsed=e),console.groupEnd||(console.groupEnd=e),console.table||(console.table=e),function(){for(var r,e=["webkit","moz"],t=0;t<e.length&&!window.requestAnimationFrame;++t){var n=e[t];window.requestAnimationFrame=window[n+"RequestAnimationFrame"],window.cancelAnimationFrame=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"]}!/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent)&&window.requestAnimationFrame&&window.cancelAnimationFrame||(r=0,window.requestAnimationFrame=function(e){var t=Date.now(),n=Math.max(r+16,t);return setTimeout(function(){e(r=n)},n-t)},window.cancelAnimationFrame=clearTimeout)}(),Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector),Element.prototype.closest||(Element.prototype.closest=function(e){var t=this;do{if(Element.prototype.matches.call(t,e))return t}while(null!==(t=t.parentElement||t.parentNode)&&1===t.nodeType);return null}),t=".minno-canvas{height:400px;width:500px;position:relative;border:5px solid #fff;margin:10px auto auto;-webkit-text-size-adjust:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;display:flex;justify-content:center;align-items:center}.minno-stimulus{position:absolute;text-align:center;overflow:hidden;visibility:hidden;width:auto;height:auto;max-width:100%}.minno-stimulus-visible{visibility:visible}.minno-progress{background-color:#20201f;border-radius:20px;padding:4px;position:absolute;top:50%;left:10%;width:80%;height:24px;margin-top:-12px}.minno-progress-bar{background-color:#807b7a;width:0;height:16px;border-radius:10px}",i=(n=void 0===(n={})?{}:n).insertAt,t&&"undefined"!=typeof document&&(r=document.head||document.getElementsByTagName("head")[0],(n=document.createElement("style")).type="text/css","top"===i&&r.firstChild?r.insertBefore(n,r.firstChild):r.appendChild(n),n.styleSheet?n.styleSheet.cssText=t:n.appendChild(document.createTextNode(t)));var g=window.piGlobal||(window.piGlobal={});function c(e,t,n){var r=this.mixerSequence;switch(e){case"nextWhere":o("next",t,n,r);break;case"previousWhere":o("prev",t,n,r);break;case"current":break;case"first":for(;r.prev(n),r.current(n););break;case"last":for(;r.next(n),r.current(n););r.prev();break;case"end":for(;r.next(n),r.current(n););break;case"next":r.next(n);break;default:throw new Error('Unknow destination "'+e+'" for goto.')}return this}function o(e,t,n,r){for(var i;r[e](),i=r.current(n),i&&!v.iteratee(t)(i.data););}var a="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function s(e,t){return e(t={exports:{}},t.exports),t.exports}var d=s(function(s){!function(e){var i=function(){},t=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.msRequestAnimationFrame||function(e){return setTimeout(e,16)};function n(){this.reads=[],this.writes=[],this.raf=t.bind(e)}function o(e){e.scheduled||(e.scheduled=!0,e.raf(function(e){var t,n=e.writes,r=e.reads;try{i("flushing reads",r.length),e.runTasks(r),i("flushing writes",n.length),e.runTasks(n)}catch(e){t=e}e.scheduled=!1,(r.length||n.length)&&o(e);if(t){if(i("task errored",t.message),!e.catch)throw t;e.catch(t)}}.bind(null,e)))}function r(e,t){t=e.indexOf(t);return!!~t&&!!e.splice(t,1)}n.prototype={constructor:n,runTasks:function(e){for(var t;t=e.shift();)t()},measure:function(e,t){e=t?e.bind(t):e;return this.reads.push(e),o(this),e},mutate:function(e,t){e=t?e.bind(t):e;return this.writes.push(e),o(this),e},clear:function(e){return r(this.reads,e)||r(this.writes,e)},extend:function(e){if("object"!=typeof e)throw new Error("expected object");var t=Object.create(this);return function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}(t,e),t.fastdom=this,t.initialize&&t.initialize(),t},catch:null};var a=e.fastdom=e.fastdom||new n;s.exports=a}("undefined"!=typeof window?window:a)});function l(e){return parseFloat(e,10)||0}function m(n,r,o){return v.throttle(function(e){"orientationchange"==e.type?setTimeout(t,500):t()},16);function t(){d.measure(function(){var e=function(e,t){var n=function(e){var t=e.proportions;if(h(t))return t;if(v.isPlainObject(t)){if([t.height,t.width].every(h))return t.height/t.width;o({type:"warn",message:"minno settings.canvas.proportions.width and settings.canvas.proportions.height must both be numeric",context:e})}t&&o({type:"warn",message:"minno settings.canvas.proportions must be either numeric or a plain object",context:e});return.8}(e);if(e.width)return h(e.width)||o({type:"warn",message:"minno settings.canvas.width must be numeric",context:e}),{width:e.width,height:e.width*n};e.maWidth&&!h(e.maxWidth)&&o({type:"warn",message:"minno settings.canvas.maxWidth must be numeric",context:e});var r=window.document.documentElement,i=r.clientHeight,t=Math.min(e.maxWidth||1/0,r.clientWidth,function(e){var t=window.getComputedStyle(e);return{height:l(e.offsetHeight)-l(t.borderTopWidth)-l(t.borderBottomWidth),width:l(e.offsetWidth)-l(t.borderLeftWidth)-l(t.borderRightWidth)}}(t.parentNode).width);return n*t<i?{height:t*n,width:t}:{height:i,width:i/n}}(r,n),t=window.getComputedStyle(n);e.height-=f(t.borderTopWidth)+f(t.borderBottomWidth)+f(t.marginTop),e.width-=f(t.borderLeftWidth)+f(t.borderRightWidth),d.mutate(function(){n.style.width=e.width+"px",n.style.height=e.height+"px",n.style.fontSize=e.height*(r.textSize||3)/100+"px",window.scrollTo(0,1)})})}}function f(e){return parseFloat(e,10)||0}function h(e){return!isNaN(parseFloat(e))&&isFinite(e)}function p(a,e){var t;if(!v.isPlainObject(a))throw new Error("canvas(map): You must set a rule map for canvas to work properly");if(v.isUndefined(e))return v.noop;if(!v.isPlainObject(e))throw new Error("canvas(settings): canvas settings must be an object");return t=v.map(e,function(e,t){var n,r,i,o=a[t];if(o)return n=o.element,r=o.property,e=e,i=n.style[r],n.style[r]=e,function(){n.style[r]=i};throw new Error("canvas("+t+"): unknow key in canvas object.")}),function(){v.forEach(t,function(e){e.call()})}}var w=s(function(e){function a(){function e(){return 0<arguments.length&&arguments[0]!==g&&t(e,arguments[0]),e._state.value}var n;return(n=e).constructor=a,n._state={id:v++,value:void 0,state:0,derive:void 0,recover:void 0,deps:{},parents:[],endStream:void 0,unregister:void 0},n.map=n["fantasy-land/map"]=u,n["fantasy-land/ap"]=c,n["fantasy-land/of"]=a,n.valueOf=l,n.toJSON=d,n.toString=l,Object.defineProperties(n,{end:{get:function(){var t;return n._state.endStream||((t=a()).map(function(e){return!0===e&&(i(n),t._state.unregister=function(){i(t)}),e}),n._state.endStream=t),n._state.endStream}}}),0<arguments.length&&arguments[0]!==g&&t(e,arguments[0]),e}function t(e,t){for(var n in r(e,t),e._state.deps)s(e._state.deps[n],!1);null!=e._state.unregister&&e._state.unregister(),function(e){for(var t in e._state.changed=!1,e._state.deps)e._state.deps[t]._state.changed=!1}(e)}function r(e,t){e._state.value=t,e._state.changed=!0,2!==e._state.state&&(e._state.state=1)}function s(e,t){var n=e._state.parents;0<n.length&&n.every(f)&&(t||n.some(h))&&((n=e._state.derive())!==g&&r(e,n))}function o(e,t){if(!t.every(m))throw new Error("Ensure that each item passed to stream.combine/stream.merge is a stream");return n=a(),r=t,i=function(){return e.apply(this,t.concat([t.filter(h)]))},(o=n._state).derive=i,o.parents=r.filter(p),function e(t,n){for(var r=0;r<n.length;r++)n[r]._state.deps[t._state.id]=t,e(t,n[r]._state.parents)}(n,o.parents),s(n,!0),n;var n,r,i,o}function i(e){for(var t,n=0;n<e._state.parents.length;n++)delete e._state.parents[n]._state.deps[e._state.id];for(t in e._state.deps){var r=e._state.deps[t],i=r._state.parents.indexOf(e);-1<i&&r._state.parents.splice(i,1)}e._state.state=2,e._state.deps={}}function u(t){return o(function(e){return t(e())},[this])}function c(e){return o(function(e,t){return e()(t())},[e,this])}function l(){return this._state.value}function d(){return null!=this._state.value&&"function"==typeof this._state.value.toJSON?this._state.value.toJSON():this._state.value}function m(e){return e._state}function f(e){return 1===e._state.state}function h(e){return e._state.changed}function p(e){return 2!==e._state.state}var v,g;v=0,g={},(a["fantasy-land/of"]=a).merge=function(e){return o(function(){return e.map(function(e){return e()})},e)},a.combine=o,a.scan=function(t,n,e){return 0===(e=o(function(e){return n=t(n,e._state.value)},[e]))._state.state&&e(n),e},a.scanMerge=function(r,i){var e=r.map(function(e){e=e[0];return 0===e._state.state&&e(void 0),e});return o(function(){var n=arguments[arguments.length-1];return e.forEach(function(e,t){-1<n.indexOf(e)&&(i=r[t][1](i,e._state.value))}),i},e)},a.HALT=g,e.exports=a}),y=function(e,t){var n,r=e.style;if(!t)return;for(n in t)r[function(e){return e.replace(/-([a-z])/g,function(e){return e[1].toUpperCase()})}(n)]=t[n]};function b(e,t){var n,r,i,o=w(),a=function(e,t,n){t=t||{};var r=w();if(!v.isElement(e))throw new Error("minno-time: canvas is not a DOM element");e.classList.add("minno-canvas");var i=p({background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:e,property:"backgroundColor"},borderColor:{element:e,property:"borderColor"},borderWidth:{element:e,property:"borderWidth"}},v.pick(t,["background","canvasBackground","borderColor","borderWidth"]));return t.css&&y(e,t.css),r.map(m(e,t,n)),r({}),window.addEventListener("orientationchange",r),window.addEventListener("resize",r),r.end.map(function(){e.classList.remove("minno-canvas")}).map(function(){window.removeEventListener("orientationchange",r),window.removeEventListener("resize",r)}).map(i),r}(e,v.get(t,"settings.canvas",{}),o),s=function(e){var t=new u;if(t.createColl("trial"),t.createColl("stimulus"),t.createColl("media"),t.add("trial",e.trialSets||[]),t.add("stimulus",e.stimulusSets||[]),t.add("media",e.mediaSets||[]),!v.isArray(e.sequence))throw new Error("You must set a sequence array.");return(e=t.sequence("trial",e.sequence)).go=c,t.currentSequence=e,t}(t);return r=g,i=(n=t).name||"anonymous minno-time",(n=n.current||{}).logs||(n.logs=[]),r[i]=r.current=n,{db:s,$resize:a,$messages:o,canvas:e,script:t,settings:t.settings||{}}}var E=[],x=[],k=0,_=v.memoize(function(r){return new Promise(function(e,t){var n=new XMLHttpRequest;n.open("GET",r,!0),n.onreadystatechange=function(){4===this.readyState&&(200<=this.status&&this.status<400?e(this.responseText):t(new Error("Template not found:"+r)))},n.send()})}),q={load:function(t,e){if(-1!==E.indexOf(t))return!1;e=("template"==e?_:function(r){return new Promise(function(e,t){if(v.includes(r,"<%"))return e();var n=document.createElement("img");n.onload=e,n.onerror=function(){t(new Error("Image not found: "+r))},n.src=r})})(t);return e.then(function(){k++}).then(function(){q.onload&&q.onload(t)}).catch(function(e){q.onerror&&q.onerror(e,t)}),x.push(e),E.push(t),e},all:function(){return Promise.all(x)},progress:function(){return x.length?k/x.length:1}};function C(e,t,n){return"image"==n&&/^data:image/.test(t)?t:((e=v.isObject(e)?e[n]:e)?"/"!=e[e.length-1]&&(e+="/"):e="",e+t)}function A(e,t){var n,r,i,o;return r=(n=e).mediaSets,i=v.map(n.stimulusSets,P),o=v.map(n.trialSets,T),e=v.filter(n.sequence,S).map(T),n=v.get(n.settings,"preloadImages",[]).map(function(e){return{image:e}}),v.flattenDeep([r,i,o,e,n]).filter(F).forEach(function(e){v.isUndefined(e.image)||q.load(C(t,e.image,"image"),"image");v.isUndefined(e.template)||q.load(C(t,e.template,"template"),"template")}),q}function T(e){return[v.map(e.input,function(e){return e.element}),v.map(e.stimuli,P),v.map(e.layout,P)]}function P(e){return e.media}function S(e){return!e.mixer}function F(e){return!v.isUndefined(e)}function $(e,n,t){var r=w(),i=n.element;return i&&(y(i,n.css),d.mutate(function(){t.appendChild(i)})),t.addEventListener(e,function(e){var t=e.target;return i&&i.contains(t)||!i&&t.closest('[data-handle="'+n.stimHandle+'"]')?r(e):void 0}),r.end.map(function(){i&&t.removeChild(i);t.removeEventListener(e,r)}),r}var L=[];function M(e){var t=w(),n=(Array.isArray(e.key)?e.key:[e.key]).map(function(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e});return document.addEventListener("keydown",r),t.end.map(function(){document.removeEventListener("keydown",r)}),t;function r(e){L[e.which]||-1===n.indexOf(e.which)||(e.preventDefault(),L[e.which]=!0,t(e))}}function j(e){var t=w(),n=(Array.isArray(e.key)?e.key:[e.key]).map(function(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e});return document.addEventListener("keyup",function(e){return-1===n.indexOf(e.which)?void 0:(e.preventDefault(),t(e))}),t.end.map(function(){document.removeEventListener("keyup",t)}),t}document.addEventListener("keyup",function(e){L[e.which]=!1});var O,N,W,z,I=window.performance.now?window.performance.now.bind(window.performance):Date.now.bind(Date),D=5;function U(e){var n=w(),r=function(e,t){if(v.isArray(e))return e[Math.floor(Math.random()*e.length)];if(v.isFunction(e))return e.call(t);if(v.isPlainObject(e)){if(!v.isNumber(e.min)||!v.isNumber(e.max)||e.min>e.max)throw new Error("randomization objects need both a max and a minimum property, also max has to be larger than min");return e.min+(e.max-e.min)*Math.random()}return e}(e.duration)||0,i=!1;return n.end.map(function(){i=!0}),r?d.measure(function(){var t=I()+ +r-D;!function e(){if(i)return;d.measure(function(){I()>=t?n({}):d.mutate(e)})}()}):n({}),n}function B(){requestAnimationFrame(function(){return N=I(),z.push(N-O),O=N,z.length<W?setTimeout(B):void(D=(e=z).reduce(function(e,t){return e+t},0)/e.length/3);var e})}function H(e,t){var n=function(e,t){if(v.isFunction(e))return e(e,t,w);if(v.isPlainObject(e)){if(v.isString(e.on))return function(e,t){var n=e.on;switch(n){case"keypressed":return M(e);case"keyup":return j(e);case"click":case"mousedown":return $("mousedown",e,t);case"mouseup":return $("mouseup",e,t);case"mouseover":return $("mouseover",e,t);case"mouseout":return $("mouseout",e,t);case"timeout":return U(e);case"enter":return M(v.assign({key:13},e));case"space":return M(v.assign({key:32},e));case"esc":return M(v.assign({key:27},e));case"leftTouch":return e.element=r(e.css,{position:"absolute",left:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),$("mousedown",e,t);case"rightTouch":return e.element=r(e.css,{position:"absolute",right:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),$("mousedown",e,t);case"topTouch":return e.element=r(e.css,{position:"absolute",top:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),$("mousedown",e,t);case"bottomTouch":return e.element=r(e.css,{position:"absolute",bottom:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),$("mousedown",e,t);default:throw new Error('You have an input element with an unrecognized "on" property: '+n)}function r(e,t){var n=document.createElement("div");return y(n,t),y(n,e),n}}(e,t);if(v.isFunction(e.on)){if(!(t=e.on(e,t,w))||!t._state)throw new Error("input.on must return a stream");return v.isFunction(e.off)&&t.end.map(e.off),t}}throw new Error("Input must only contain objects and functions, do you have an undefined value?")}(e,t);if(!n._state)throw new Error("Input functions must return valid streams: "+(t=e,v.isFunction(t)?t.toString():JSON.stringify(t)));return"handle"in e&&(n.handle=e.handle),n}function R(n,r){var i=[],o=0;return{add:function(e){if(!e)throw new Error("Missing input element. Could not add input listener");var t=H(e,r);t.map(function(e){return{handle:t.handle,event:e,timestamp:+new Date,latency:I()-o}}).map(n),i.push(t)},remove:function(e){for(var t=i.length-1;0<=t;t--){var n=i[t];n.handle===e&&(n.end(!0),i.splice(t,1))}},removeAll:function(){i.forEach(function(e){e.end(!0)}),i.length=0},resetTimer:function(){o=I()}}}function G(i,o){var a,e=i.html||i.inlineTemplate||i.template;return v.isFunction(i)?function(e){e=e();return function(e){return e&&v.isFunction(e.then)}(e)?e.then(function(e){return v.isElement(e)?e:Promise.reject("Custom media must resolve with an element")}):Promise.reject(new Error("Custom media must return a promise"))}(i):(J(i)&&(i={word:i}),J(i.word)?((a=document.createElement("div")).textContent=i.word,Promise.resolve(a)):e?((a=document.createElement("div")).innerHTML=e,Promise.resolve(a)):i.$image?new Promise(function(t,e){var n=performance.now(),r=i.$image;(a=document.createElement("img")).onload=function(){var e=performance.now()-n;16<e&&o({type:"warn",message:'It took too long to load "'+r+'" ('+e+"ms). Make sure that it was preloaded properly.",context:r}),t(a)},a.onerror=function(){e(new Error("Image not found: "+a.src))},a.src=r}):i.jquery?Promise.reject(new Error("Jquery is no longer supported in minno-time")):Promise.reject(new Error("Unrecognized media type")))}function J(e){return v.isString(e)||v.isNumber(e)}function Y(e,t){var n=e.style,r=t.size||{};return r.font_size&&(n.fontSize=r.font_size),"height"in r&&(t=t.media,!v.isString(t)&&!v.isString(t.word))&&(n.height=r.height+"%"),"width"in r&&(n.width=r.width+"%"),e}function X(t,e){var n=e.location||{};["top","bottom","left","right"].forEach(function(e){!function(e){return!isNaN(+e)}(n[e])||(t.style[e]=n[e]+"%")})}W=50,z=[],requestAnimationFrame(function(){O=I(),B()});var V=window.document.documentMode;function K(n,u,c){var l=n.canvas;return n.el=c,new Promise(function(t){d.mutate(function(){function r(e,t){return"center"===e||"center"===t||void 0===e&&void 0===t}var i,o,e,a,s;c.classList.add("minno-stimulus"),c.setAttribute("data-handle",n.handle),c.style.zIndex=10*u,l.appendChild(c),Y(c,n.source),X(c,n.source),y(c,n.source.css||{}),V?(o=t,e=(i=n).canvas,a=i.el,s=i.source.location||{},d.measure(function(){var t=100*a.clientWidth/e.clientWidth,n=100*a.clientHeight/e.clientHeight;d.mutate(function(){var e=a.style;e.width=t+"%",e.height=n+"%",r(s.top,s.bottom)&&(e.top=(100-n)/2+"%"),r(s.left,s.right)&&(e.left=(100-t)/2+"%"),i.source.isLayout&&a.classList.add("minno-stimulus-visible"),o(a)})})):(n.source.isLayout&&c.classList.add("minno-stimulus-visible"),t(c))})})}function Q(e){var t=this.source,n=this.trial.$messages;if(!this.source.media)throw new Error("Media object not defined for "+this.name());return G(this.source.media,n).then(K.bind(null,this,e)).catch(function(e){throw n({type:"error",message:"trial.stimulus error",error:e,context:t}),e})}function Z(){var e=this.el;if(!e)throw new Error("A stimulus can not be shown before init is called");d.mutate(function(){e.classList.add("minno-stimulus-visible")})}function ee(){var e=this.el;if(!e)throw new Error("A stimulus can not be hidden before init is called");d.mutate(function(){e.classList.remove("minno-stimulus-visible")})}function te(){var e=this.el,t=this.canvas;d.mutate(function(){t.removeChild(e)})}function ne(){var e=this.source;return e.alias||(this.data&&this.data.alias?this.data.alias:e.inherit&&e.inherit.set?e.inherit.set:this.handle||void 0)}function re(e){var t,n=this.source.media,r=e&&e.fullpath;if(n.alias)return n.alias;if(n.data&&n.data.alias)return n.data.alias;for(t in n){if(ie(["image","template"],t))return r?n[t]:n[t].replace(/^.*[\\/]/,"");if(ie(["word","html","inlineTemplate"],t)&&n[t])return n[t]}}function ie(e,t){return-1!=e.indexOf(t)}function oe(n,r){ce("stimuli",n._source),ce("layout",n._source);var e=n._source,t=v.map(e.stimuli,o),i=v.map(e.layout,function(e){return e.isLayout=!0,e}).map(o),e=t.concat(i).map(function(e,t){return e.init(t)});return{canvas:r,stimuli:t,layout:i,ready:Promise.all(e),getStimlist:ae,getMedialist:se,destroy:ue};function o(e){return(e={el:null,source:t=e,trial:n,canvas:e=r,init:Q,show:Z,hide:ee,name:ne,mediaName:re,destroy:te}).data=t.data||{},e.handle=e.data.handle=e.data.handle||t.handle||t.set,e;var t}}function ae(){return this.stimuli.filter(function(e){return!e.source.nolog}).map(function(e,t){return e.name()||"stim"+t})}function se(n){return this.stimuli.filter(function(e){return!e.source.nolog}).map(function(e,t){return e.mediaName(n)||"media"+t})}function ue(){this.stimuli.concat(this.layout).forEach(function(e){e.destroy()})}function ce(e,t){t=t[e];if(t){if(!Array.isArray(t))throw new Error(e+" must be an array");if(!t.every(function(e){return"media"in e}))throw new Error("Each "+e+" stimulus must have a media property")}}var le=g,de={begin:function(e){return"begin"===e.type},inputEquals:function(e,t){return-1!==(Array.isArray(t.value)?t.value:[t.value]).indexOf(e.handle)},inputEqualsTrial:function(e,t,n){return e.handle===n.data[t.property]},inputEqualsStim:function(e,t,n){var r={};t.handle&&(r.handle=t.handle);return r[t.property]=e.handle,me(r,n)},trialEquals:function(e,t,n){if(v.isUndefined(t.property)||v.isUndefined(t.value))throw new Error('trialEquals requires both "property" and "value" to be defined');return t.value===n.data[t.property]},inputEqualsGlobal:function(e,t){if(v.isUndefined(t.property))throw new Error('inputEqualsGlobal requires "property" to be defined');return e.handle===le[t.property]},globalEquals:function(e,t){if(void 0===t.property||void 0===t.value)throw new Error('globalEquals requires both "property" and "value" to be defined');return t.value===le[t.property]},globalEqualsTrial:function(e,t,n){if(void 0===t.globalProp||void 0===t.trialProp)throw new Error('globalEqualsTrial requires both "globalProp" and "trialProp" to be defined');return le[t.globalProp]===n.data[t.trialProp]},globalEqualsStim:function(e,t,n){if(void 0===t.globalProp||void 0===t.stimProp)throw new Error('globalEqualsStim requires both "globalProp" and "stimProp" to be defined');var r={};t.handle&&(r.handle=t.handle);return r[t.stimProp]=le[t.globalProp],me(r,n)},currentEquals:function(e,t){var n=le.current;if(void 0===t.property||void 0===t.value)throw new Error('currentEquals requires both "property" and "value" to be defined');return t.value===n[t.property]},currentEqualsTrial:function(e,t,n){var r=le.current;if(void 0===t.currentProp||void 0===t.trialProp)throw new Error('currentEqualsTrial requires both "currentProp" and "trialProp" to be defined');return r[t.currentProp]===n.data[t.trialProp]},currentEqualsStim:function(e,t,n){var r=le.current;if(void 0===t.currentProp||void 0===t.stimProp)throw new Error('currentEqualsStim requires both "currentProp" and "stimProp" to be defined');var i={};t.handle&&(i.handle=t.handle);return i[t.stimProp]=r[t.currentProp],me(i,n)},inputEqualsCurrent:function(e,t){var n=le.current;if(void 0===t.property)throw new Error('inputEqualsCurrent requires "property" to be defined');return e.handle===n[t.property]},fn:function(e,t,n){return t.value.apply(n,[t,e,n])},custom:function(e,t,n){return t.fn.apply(null,[t,e,n])}};function me(r,e){return e.stimulusCollection.stimuli.some(function(e){var t,n=e.data;for(t in r)if(r[t]!==n[t])return!1;return!0})}function fe(e,n,r){return!!(e=Array.isArray(e)?e:[e]).length&&(("begin"!=n.type||!e.every(function(e){return"begin"!=e.type}))&&e.every(function(e){var t=function(e){if(v.isFunction(e))return e;if(v.isFunction(de[e.type]))return de[e.type];throw new Error("Unknown condition type: "+JSON.stringify(e))}(e)(n,e,r);return e.negate?!t:t}))}var he={showStim:function(e,t,n){var r=e.handle||e;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||e.show()})},hideStim:function(e,t,n){var r=e.handle||e;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||e.hide()})},setStimAttr:function(e,t,n){var r=e.handle,i=e.setter;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||(v.isFunction(i)?i.apply(e):v.extend(e.data,i))})},setTrialAttr:function(e,t,n){e=e.setter;if(void 0===e)throw new Error("The setTrialAttr action requires a setter property");v.isFunction(e)?e.apply(n,[n.data,t]):v.extend(n.data,e)},setInput:function(e,t,n){if(void 0===e.input)throw new Error("The setInput action requires an input property");n.input.add(e.input)},trigger:function(e,t,n){if(void 0===e.handle)throw new Error("The trigger action requires a handle property");n.input.add({handle:e.handle,on:"timeout",duration:+e.duration||0})},removeInput:function(e,t,n){n=n.input,e=e.handle;if(void 0===e)throw new Error("The removeInput action requires a handle property");Array.isArray(e)||(e=[e]),v.includes(e,"All")?n.removeAll():e.forEach(n.remove)},goto:function(e,t,n){n._next=[e.destination,e.properties]},endTrial:function(){},resetTimer:function(e,t,n){function r(){t.latency=0,n.input.resetTimer()}e.immidiate?r():d.mutate(r)},log:function(e,t,n){n.$logs(arguments)},setGlobalAttr:function(e){switch(typeof e.setter){case"function":e.setter.apply(null,[g,e]);break;case"object":v.extend(g,e.setter);break;default:throw new Error('setGlobalAttr requires a "setter" property')}},custom:function(e,t,n){if("function"!=typeof e.fn)throw new Error("The custom action requires a fn propery");e.fn(e,t,n)},canvas:function(e,t,n){var r=n.cavnas,e=p({background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:r,property:"backgroundColor"},borderColor:{element:r,property:"borderColor"},borderWidth:{element:r,property:"borderWidth"}},v.pick(e,["background","canvasBackground","borderColor","borderWidth"]));n.$end.map(e)},startMouseTracking:function(t,e,n){if(n.data.listener)return n.$message({type:"warn",message:"Mouse tracking has already been activated."});var o=performance.now(),a=n.canvas,s=t.logAs||"mousetracker",r=getComputedStyle(a),u=parseInt(r.getPropertyValue("border-top-width")),c=parseInt(r.getPropertyValue("border-left-width")),l=n.stimulusCollection.stimuli.filter(function(e){return v.includes(t.logStimulusLocation,e.handle)}),i=v.throttle(function(e){var t=a.getBoundingClientRect(),r=t.x+c,i=t.y+u,e={mouseX:e.clientX-r,mouseY:e.clientY-i},e=l.reduce(function(e,t){var n=t.el.getBoundingClientRect();return v.set(e,t.handle+"X",n.x-r),v.set(e,t.handle+"Y",n.y-i),v.set(e,t.handle+"Width",n.width),v.set(e,t.handle+"Height",n.height),e},e),e=v.mapValues(v.set(e,"time",performance.now()-o),Math.round);n.data[s].push(e)},t.logRate||15);n.data[s]||(n.data[s]=[]),n.data.$listener=i,document.addEventListener("mousemove",i),n.$events.end.map(function(){document.removeEventListener("mousemove",i)})},stopMouseTracking:function(e,t,n){v.isFunction(n.data.$listener)&&(document.removeEventListener("mousemove",n.data.$listener),n.data.$listener=void 0)}};function pe(s){var u=0,c=s._source.interactions;try{!function(e){if(!Array.isArray(e))throw new Error("Interactions must be an array");if(!e.length)throw new Error("There are no interactions defined");if(!e.every(v.isPlainObject))throw new Error("Interactions must be plain objects");if(!e.every(t("conditions")))throw new Error("Conditions must be either an array or a function");if(!e.every(t("actions")))throw new Error("Actions must be either an array or a function");function t(t){return function(e){return Array.isArray(e[t])||v.isFunction(e[t])}}}(c)}catch(e){throw s.$messages({type:"error",message:"trial.interactions error",error:e,context:s._source}),e}return function(e){var t,n,r,i,o="Event: "+(e.handle||e.type),a=[];if(50<u)throw new Error("It seem you have created an infinite loop. Minno has been halted");u++;try{for(t=0;t<c.length&&(n=c[t],r=fe(n.conditions,e,s),a.push([r,n.conditions]),!(i=r?function(e,n,r){var i=!1;return e=v.isArray(e)?e:[e],v.forEach(e,function(e){var t=v.isFunction(e)?e:he[e.type];if(!t)throw new Error("unknown action: "+e.type);"endTrial"===e.type&&(i=!0),t(e,n,r)}),i}(n.actions,e,s):i));t++);}catch(e){throw s.$messages({type:"error",message:"trial.interactions error",error:e}),e}u--,s.$messages({type:"debug",message:o,rows:a}),i&&s.end();return e}}var ve=0;function ge(e,t,n){if(!e.interactions)throw new Error("Interactions not defined");this.canvas=t,this.settings=n,this._source=e,this.$logs=w(),this.$messages=w(),this.$events=w(),this.$end=this.$events.end,this.data=e.data||{},this._id=v.uniqueId("trial_"),this.counter=ve++,this.input=R(this.$events,t),this.stimulusCollection=oe(this,t),this._next=["next",{}]}function we(e,t,n){var r=window.piGlobal,i=n.data,o=t,a=r.current.logs,t=v.get(n,"settings.logger.fullpath",!1),r=n.stimulusCollection.getStimlist(),t=n.stimulusCollection.getMedialist({fullpath:t});return{log_serial:a.length,trial_id:n.counter,name:n.name(),responseHandle:o.handle,latency:Math.floor(o.latency),stimuli:r,media:t,data:i}}function ye(r){var i,e,t,n,o,u,a=r.canvas,c=r.db,l=r.settings,s=g,d=w(),m=d.map(function(e){var t=i,n=i=new ge(e,a,l);n.$logs.map(f),n.$messages.map(r.$messages),e.DEBUG&&window.DEBUG&&function(e){var t="Trial :"+e.counter;console.group(t),e.$messages.map(function(e){return"debug"!==e.type||(e.rows?(console.groupCollapsed(e.message),e.rows.forEach(function(e){console.log.apply(console,e)}),console.groupEnd(e.message)):console.log(e.message)),e}),e.$events.end.map(function(){console.groupEnd(t)})}(n);n.$end.map(function(){p(n._next)}),n.start(),t&&n.stimulusCollection.ready.then(function(){t.stimulusCollection.destroy()});return n}),f=w(),e=(e=f,n=r.script,h=s,o=v.assign({},v.get(n,"settings.logger")),h=v.assign({taskName:n.name},h.$meta,o.metaData),o.metaData=h,h=we,h=(o=o).logger||o.logMap||h,e.map((t=h,function(e){return t.apply(null,e)}))),h=v.get(l,"hooks.endTask",l.onEnd||v.noop),h=new Promise(function(e){u=e}).then(d.end.bind(null,!0)).then(function(){var e=m();e&&e.stimulusCollection.destroy()}).then(h);return e.map(function(e){s.current.logs.push(e)}),d.end.map(m.end).map(f.end),v.extend({$trial:m,$logs:e,start:p.bind(null,["next",{}]),end:u,promise:h},r);function p(e){var i,o,t,n,r,e=(i=c,o=l,n=(t=e)[0],r=t[1],e=i.currentSequence,t={global:g,current:g.current},e.go(n,r,t),e=e.current(t,{skip:["layout","stimuli"]}),(e=v.clone(e))?(t.trialData=e.data,t.trialMeta=e.$meta,e.stimuli=v.map(e.stimuli||[],s.bind(t)),e.layout=v.map(e.layout||[],s.bind(t)),{value:e}):{done:!0});function a(e,t,n){var r=e[t];v.isUndefined(r)||((v.isString(r)||v.isNumber(r))&&(r={word:r}),(r=i.inflate("media",r,n)).image&&(r.$image=C(o.base_url,r.image,"image")),r.template&&(r.inlineTemplate=requirejs("text!"+C(o.base_url,r.template,"template")),r.inlineTemplate=v.template(r.inlineTemplate)(n)),e[t]=r,n.mediaData=null,n.mediaMeta=null)}function s(e){var t=this;return e=i.inflate("stimulus",e,t,{skip:["media","touchMedia"]}),a(e=v.clone(e),"media",t),a(e,"touchMedia",t),t.stimulusData=null,t.stimulusMeta=null,e}e.done?u():d(e.value)}}return v.extend(ge.prototype,{start:function(){var e=this;return e.stimulusCollection.ready.then(function(){var t;e.$events.map((t=e,function(e){return v.assign(e,{trialId:t._id,counter:t.counter})})).map(pe(e)),v.forEach(e._source.input,e.input.add),e.input.resetTimer(),e.$events({type:"begin",latency:0})})},end:function(){this.input.removeAll(),this.$end(!0)},name:function(){return this.alias||this.data.alias||(v.isString(this._source.inherit)?this._source.inherit:v.isPlainObject(this._source.inherit)?this._source.inherit.set:void 0)}}),function(e,t){var n=ye(b(e,t));return n.$trial.end.map(n.$resize.end),function(e,t,n){var r=A(t,t.settings.base_url);if(1==r.progress())return Promise.resolve().then(o);e.innerHTML='<div class="minno-progress"><div class="minno-progress-bar"></div></div>';var i=e.getElementsByClassName("minno-progress-bar")[0].style;return i.width=r.progress()+"%",r.onload=function(){d.mutate(function(){i.width=100*r.progress()+"%"})},r.onerror=function(e,t){n({type:"error",message:"Failed to preload",error:e,context:t})},r.all().then(o).catch(function(e){throw new Error("loading resource failed, do something about it! (you can start by checking the error log, you are probably reffering to the wrong url - "+e+")")});function o(){for(;e.firstChild;)e.removeChild(e.firstChild)}}(e,t,n.$messages).then(n.start),n}});
//# sourceMappingURL=time.js.map
