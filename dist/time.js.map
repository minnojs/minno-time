{"version":3,"file":"time.js","sources":["../src/polyfills.js","../src/app/global.js","../src/app/task/sequencer/sequenceGoto.js","../node_modules/fastdom/fastdom.js","../src/app/task/canvas/getSize.js","../src/app/task/canvas/adjust_canvas.js","../src/app/task/canvas/applyCanvasStyles.js","../node_modules/mithril-stream/stream.js","../node_modules/minno-css/css.js","../src/app/setup.js","../src/app/task/canvas/canvasSetup.js","../src/app/task/sequencer/createDB.js","../src/app/task/sequencer/preloader.js","../src/app/task/sequencer/buildUrl.js","../src/app/task/sequencer/scriptPreloader.js","../src/app/trial/input/bindings/mouseEvents.js","../src/app/trial/input/bindings/keypressed.js","../src/app/trial/input/bindings/keyup.js","../src/app/trial/input/now.js","../src/app/trial/input/bindings/timeout.js","../src/app/trial/input/bindings/simpleRandomize.js","../src/app/trial/input/createListener.js","../src/app/trial/input/binder.js","../src/app/trial/input/input.js","../src/app/trial/stimulus/getMedia.js","../src/app/trial/stimulus/setSize.js","../src/app/trial/stimulus/setPlace.js","../src/app/trial/stimulus/setupElement.js","../src/app/trial/stimulus/Stimulus.js","../src/app/trial/stimulus/stimulusCollection.js","../src/app/trial/interactions/getConditionFn.js","../src/app/trial/interactions/conditionsEvaluate.js","../src/app/trial/interactions/actionList.js","../src/app/trial/interactions/interactions.js","../src/app/trial/interactions/action.js","../src/app/trial/Trial.js","../src/app/task/logger/defaultLogMap.js","../src/app/playPhase.js","../src/app/task/logger/createLogStream.js","../src/app/task/sequencer/nextTrial.js","../src/index.js","../src/app/preloadPhase.js"],"sourcesContent":["import 'promise-polyfill';\n// performance.now polyfill\n(function(w){\n\tvar perfNow;\n\tvar perfNowNames = ['now', 'webkitNow', 'msNow', 'mozNow'];\n\tif(!!w['performance']) for(var i = 0; i < perfNowNames.length; ++i)\n\t{\n\t\tvar n = perfNowNames[i];\n\t\tif(!!w['performance'][n])\n\t\t{\n\t\t\tperfNow = function(){return w['performance'][n]()};\n\t\t\tbreak;\n\t\t}\n\t}\n\tif(!perfNow)\n\t{\n\t\tperfNow = Date.now;\n\t}\n\tw.perfNow = perfNow;\n})(window);\n\n// console.group polyfill\nfunction log(){ console.log.apply(console, arguments); }\nif (!console.group) console.group = log;\nif (!console.groupCollapsed) console.groupCollapsed = log;\nif (!console.groupEnd) console.groupEnd = log;\nif (!console.table) console.table = log;\n\n\n// requestAnimationFrame polyfill\n(function() {\n    'use strict';\n\n    var vendors = ['webkit', 'moz'];\n    for (var i = 0; i < vendors.length && !window.requestAnimationFrame; ++i) {\n        var vp = vendors[i];\n        window.requestAnimationFrame = window[vp+'RequestAnimationFrame'];\n        window.cancelAnimationFrame = (window[vp+'CancelAnimationFrame']\n            || window[vp+'CancelRequestAnimationFrame']);\n    }\n    // iOS6 is buggy\n    if (/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent) || !window.requestAnimationFrame || !window.cancelAnimationFrame) {\n        var lastTime = 0;\n        window.requestAnimationFrame = function(callback) {\n            var now = Date.now();\n            var nextTime = Math.max(lastTime + 16, now);\n            return setTimeout(function() { callback(lastTime = nextTime); },\n                              nextTime - now);\n        };\n        window.cancelAnimationFrame = clearTimeout;\n    }\n}());\n\n/**\n * Element.closest polyfill\n * For IE9 only\n * from https://developer.mozilla.org/en-US/docs/Web/API/Element/closest#browser_compatibility\n **/\nif (!Element.prototype.matches) {\n  Element.prototype.matches =\n    Element.prototype.msMatchesSelector ||\n    Element.prototype.webkitMatchesSelector;\n}\n\nif (!Element.prototype.closest) {\n  Element.prototype.closest = function(s) {\n    var el = this;\n\n    do {\n      if (Element.prototype.matches.call(el, s)) return el;\n      el = el.parentElement || el.parentNode;\n    } while (el !== null && el.nodeType === 1);\n    return null;\n  };\n}\n","export default global;\n\n// initiate piGloabl\nvar glob = window.piGlobal || (window.piGlobal = {});\n\nfunction global(){\n    return glob;\n}\n\n","/**\n * Go to a destination within the sequence (must be a property of a sequence)\n * @param  {String} target destination type\n * @param  {Object} properties destination options\n * @return {Object}        result element\n */\n\nimport _ from 'lodash';\nexport default go;\n\nfunction go(destination, properties, context){\n    var mixerSequence = this.mixerSequence;\n\n    switch (destination){\n        case 'nextWhere':\n            where('next', properties, context, mixerSequence);\n            break;\n        case 'previousWhere':\n            where('prev', properties, context, mixerSequence);\n            break;\n        case 'current':\n            // don't need to do anything...\n            break;\n        case 'first':\n            do {mixerSequence.prev(context);} while (mixerSequence.current(context));\n            break;\n        case 'last':\n            do {mixerSequence.next(context);} while (mixerSequence.current(context));\n            mixerSequence.prev();\n            break;\n        case 'end':\n            do {mixerSequence.next(context);} while (mixerSequence.current(context));\n            break;\n        case 'next' :\n            mixerSequence.next(context); // get the next trial, in case there are no more trials, returns undefined\n            break;\n        default:\n            throw new Error('Unknow destination \"' + destination + '\" for goto.');\n    }\n\n    return this;\n}\n\nfunction where(direction, properties, context, sequence){\n    var curr;\n\n    do {\n        sequence[direction]();\n        curr = sequence.current(context);\n    } while (curr && !_.iteratee(properties)(curr.data));\n}\n","!(function(win) {\n\n/**\n * FastDom\n *\n * Eliminates layout thrashing\n * by batching DOM read/write\n * interactions.\n *\n * @author Wilson Page <wilsonpage@me.com>\n * @author Kornel Lesinski <kornel.lesinski@ft.com>\n */\n\n'use strict';\n\n/**\n * Mini logger\n *\n * @return {Function}\n */\nvar debug = 0 ? console.log.bind(console, '[fastdom]') : function() {};\n\n/**\n * Normalized rAF\n *\n * @type {Function}\n */\nvar raf = win.requestAnimationFrame\n  || win.webkitRequestAnimationFrame\n  || win.mozRequestAnimationFrame\n  || win.msRequestAnimationFrame\n  || function(cb) { return setTimeout(cb, 16); };\n\n/**\n * Initialize a `FastDom`.\n *\n * @constructor\n */\nfunction FastDom() {\n  var self = this;\n  self.reads = [];\n  self.writes = [];\n  self.raf = raf.bind(win); // test hook\n  debug('initialized', self);\n}\n\nFastDom.prototype = {\n  constructor: FastDom,\n\n  /**\n   * We run this inside a try catch\n   * so that if any jobs error, we\n   * are able to recover and continue\n   * to flush the batch until it's empty.\n   *\n   * @param {Array} tasks\n   */\n  runTasks: function(tasks) {\n    debug('run tasks');\n    var task; while (task = tasks.shift()) task();\n  },\n\n  /**\n   * Adds a job to the read batch and\n   * schedules a new frame if need be.\n   *\n   * @param  {Function} fn\n   * @param  {Object} ctx the context to be bound to `fn` (optional).\n   * @public\n   */\n  measure: function(fn, ctx) {\n    debug('measure');\n    var task = !ctx ? fn : fn.bind(ctx);\n    this.reads.push(task);\n    scheduleFlush(this);\n    return task;\n  },\n\n  /**\n   * Adds a job to the\n   * write batch and schedules\n   * a new frame if need be.\n   *\n   * @param  {Function} fn\n   * @param  {Object} ctx the context to be bound to `fn` (optional).\n   * @public\n   */\n  mutate: function(fn, ctx) {\n    debug('mutate');\n    var task = !ctx ? fn : fn.bind(ctx);\n    this.writes.push(task);\n    scheduleFlush(this);\n    return task;\n  },\n\n  /**\n   * Clears a scheduled 'read' or 'write' task.\n   *\n   * @param {Object} task\n   * @return {Boolean} success\n   * @public\n   */\n  clear: function(task) {\n    debug('clear', task);\n    return remove(this.reads, task) || remove(this.writes, task);\n  },\n\n  /**\n   * Extend this FastDom with some\n   * custom functionality.\n   *\n   * Because fastdom must *always* be a\n   * singleton, we're actually extending\n   * the fastdom instance. This means tasks\n   * scheduled by an extension still enter\n   * fastdom's global task queue.\n   *\n   * The 'super' instance can be accessed\n   * from `this.fastdom`.\n   *\n   * @example\n   *\n   * var myFastdom = fastdom.extend({\n   *   initialize: function() {\n   *     // runs on creation\n   *   },\n   *\n   *   // override a method\n   *   measure: function(fn) {\n   *     // do extra stuff ...\n   *\n   *     // then call the original\n   *     return this.fastdom.measure(fn);\n   *   },\n   *\n   *   ...\n   * });\n   *\n   * @param  {Object} props  properties to mixin\n   * @return {FastDom}\n   */\n  extend: function(props) {\n    debug('extend', props);\n    if (typeof props != 'object') throw new Error('expected object');\n\n    var child = Object.create(this);\n    mixin(child, props);\n    child.fastdom = this;\n\n    // run optional creation hook\n    if (child.initialize) child.initialize();\n\n    return child;\n  },\n\n  // override this with a function\n  // to prevent Errors in console\n  // when tasks throw\n  catch: null\n};\n\n/**\n * Schedules a new read/write\n * batch if one isn't pending.\n *\n * @private\n */\nfunction scheduleFlush(fastdom) {\n  if (!fastdom.scheduled) {\n    fastdom.scheduled = true;\n    fastdom.raf(flush.bind(null, fastdom));\n    debug('flush scheduled');\n  }\n}\n\n/**\n * Runs queued `read` and `write` tasks.\n *\n * Errors are caught and thrown by default.\n * If a `.catch` function has been defined\n * it is called instead.\n *\n * @private\n */\nfunction flush(fastdom) {\n  debug('flush');\n\n  var writes = fastdom.writes;\n  var reads = fastdom.reads;\n  var error;\n\n  try {\n    debug('flushing reads', reads.length);\n    fastdom.runTasks(reads);\n    debug('flushing writes', writes.length);\n    fastdom.runTasks(writes);\n  } catch (e) { error = e; }\n\n  fastdom.scheduled = false;\n\n  // If the batch errored we may still have tasks queued\n  if (reads.length || writes.length) scheduleFlush(fastdom);\n\n  if (error) {\n    debug('task errored', error.message);\n    if (fastdom.catch) fastdom.catch(error);\n    else throw error;\n  }\n}\n\n/**\n * Remove an item from an Array.\n *\n * @param  {Array} array\n * @param  {*} item\n * @return {Boolean}\n */\nfunction remove(array, item) {\n  var index = array.indexOf(item);\n  return !!~index && !!array.splice(index, 1);\n}\n\n/**\n * Mixin own properties of source\n * object into the target.\n *\n * @param  {Object} target\n * @param  {Object} source\n */\nfunction mixin(target, source) {\n  for (var key in source) {\n    if (source.hasOwnProperty(key)) target[key] = source[key];\n  }\n}\n\n// There should never be more than\n// one instance of `FastDom` in an app\nvar exports = win.fastdom = (win.fastdom || new FastDom()); // jshint ignore:line\n\n// Expose to CJS & AMD\nif ((typeof define) == 'function') define(function() { return exports; });\nelse if ((typeof module) == 'object') module.exports = exports;\n\n})( typeof window !== 'undefined' ? window : this);\n","export default getSize;\n\n// helper function: returns sizes of element;\nfunction getSize(el){\n    var computedStyle = window.getComputedStyle(el);\n    return {\n        height    : parse(el.offsetHeight) - parse(computedStyle.borderTopWidth) - parse(computedStyle.borderBottomWidth),\n        width    : parse(el.offsetWidth) - parse(computedStyle.borderLeftWidth) - parse(computedStyle.borderRightWidth)\n    };\n}\n\nfunction parse(num){ return parseFloat(num, 10) || 0;}\n","/*\n * adjust canvas according to window size and settings\n * this module is built to be part of the main view\n */\n\nimport _ from 'lodash';\nimport fastdom from 'fastdom';\nimport getSize from './getSize';\n\nexport default adjust_canvas;\n\n// the function to be used by the main view\nfunction adjust_canvas(canvas, settings, $messages){\n\n    return _.throttle(eventListener, 16);\n\n    function eventListener(event){\n        // we put this in a time out because of a latency of orientation change on android devices\n        if (event.type == 'orientationchange') setTimeout(resize, 500);\n        else resize();\n    }\n\n    function resize(){\n        fastdom.measure(function(){\n            var targetSize = getTargetSize(settings, canvas);\n\n            // remove border width and top margin from calculated width (can't depend on cool box styles yet...)\n            // we compute only margin-top because of a difference calculating margins between chrome + IE and firefox + mobile\n            var computedStyle = window.getComputedStyle(canvas);\n            targetSize.height -= parse(computedStyle.borderTopWidth) + parse(computedStyle.borderBottomWidth) + parse(computedStyle.marginTop);\n            targetSize.width -= parse(computedStyle.borderLeftWidth) + parse(computedStyle.borderRightWidth);\n\n            fastdom.mutate(function(){\n                // reset canvas size\n                canvas.style.width = targetSize.width + 'px';\n                canvas.style.height = targetSize.height + 'px';\n                canvas.style.fontSize = targetSize.height*(settings.textSize || 3)/100 + 'px';\n\n                // scroll to top of window (hides some of the mess on the top of mobile devices)\n                window.scrollTo(0, 1);\n            });\n        });\n    }\n\n    function getProportions(settings){\n        var proportions = settings.proportions;\n        if (isNumeric(proportions)) return proportions;\n        if (_.isPlainObject(proportions)) {\n            if ([proportions.height, proportions.width].every(isNumeric)) return proportions.height/proportions.width; \n            $messages({\n                type: 'warn',\n                message: 'minno settings.canvas.proportions.width and settings.canvas.proportions.height must both be numeric',\n                context: settings\n            });\n        }\n        if (proportions) $messages({\n            type: 'warn',\n            message: 'minno settings.canvas.proportions must be either numeric or a plain object',\n            context: settings\n        });\n        return 0.8;\n    }\n\n    function getTargetSize(settings, canvas){\n        // calculate proportions (as height/width)\n        var proportions = getProportions(settings);\n\n        // static canvas size\n        // ------------------\n        if (settings.width) {\n            if (!isNumeric(settings.width)) $messages({\n                type: 'warn',\n                message: 'minno settings.canvas.width must be numeric',\n                context: settings\n            });\n            return {\n                width: settings.width,\n                height: settings.width*proportions\n            };\n        }\n\n        // dynamic canvas size\n        // -------------------\n        if (settings.maWidth && !isNumeric(settings.maxWidth)) $messages({\n            type: 'warn',\n            message: 'minno settings.canvas.maxWidth must be numeric',\n            context: settings\n        });\n\n        var docElement = window.document.documentElement; // used to get client view size\n\n        var maxHeight = docElement.clientHeight;\n        var maxWidth = Math.min(settings.maxWidth || Infinity, docElement.clientWidth, getSize(canvas.parentNode).width);\n\n        // calculate the correct size for this screen size\n        if (maxHeight > proportions * maxWidth) return { height: maxWidth*proportions, width: maxWidth };\n        else return { height: maxHeight, width: maxHeight/proportions};\n    }\n}\n\nfunction parse(num){ return parseFloat(num, 10) || 0;}\nfunction isNumeric(n){ return !isNaN(parseFloat(n)) && isFinite(n); }\n","/**\n *\n * This whole module taken from piManager\n *\n */\n\nimport _ from 'lodash';\nexport default canvasContructor;\n\n/**\n * Takes a map of css rules and applies them.\n * Returns a function that returns the page to its former condition.\n *\n * The rule map is an object of ruleName -> ruleObject.\n *\n * var ruleObject = {\n * \telement : wrapped element to affect\n * \tproperty: css property to modify\n * }\n *\n * @param  {Object} map      A hash of rules.\n * @param  {Object} settings A hash of ruleName -> value\n * @return {Function}        A function that undoes all the previous changes\n */\nfunction canvasContructor(map, settings){\n    var offArr;\n\n    if (!_.isPlainObject(map)) throw new Error('canvas(map): You must set a rule map for canvas to work properly');\n\n    // if settings is undefined return a function that doesn't do anything\n    // just so we don't need to make sure that the user modifies the canvas\n    if (_.isUndefined(settings)) return _.noop;\n    if (!_.isPlainObject(settings)) throw new Error('canvas(settings): canvas settings must be an object');\n\n    // create an array of off functions to undo any changes by this action\n    offArr = _.map(settings, function(value,key){\n        var rule = map[key];\n        if (rule) return on(rule.element, rule.property, value);\n        throw new Error('canvas('+ key +'): unknow key in canvas object.');\n    });\n\n    return function off(){\n        _.forEach(offArr, function(fn){fn.call();});\n    };\n}\n\nfunction on(el, property, value){\n    var old = el.style[property]; // save old value\n    el.style[property] = value; // set new value\n    return function(){el.style[property] = old;};  // create off function\n}\n","/* eslint-disable */\r\n;(function() {\r\n\"use strict\"\r\n/* eslint-enable */\r\n\r\nvar guid = 0, HALT = {}\r\nfunction createStream() {\r\n\tfunction stream() {\r\n\t\tif (arguments.length > 0 && arguments[0] !== HALT) updateStream(stream, arguments[0])\r\n\t\treturn stream._state.value\r\n\t}\r\n\tinitStream(stream)\r\n\r\n\tif (arguments.length > 0 && arguments[0] !== HALT) updateStream(stream, arguments[0])\r\n\r\n\treturn stream\r\n}\r\nfunction initStream(stream) {\r\n\tstream.constructor = createStream\r\n\tstream._state = {id: guid++, value: undefined, state: 0, derive: undefined, recover: undefined, deps: {}, parents: [], endStream: undefined, unregister: undefined}\r\n\tstream.map = stream[\"fantasy-land/map\"] = map, stream[\"fantasy-land/ap\"] = ap, stream[\"fantasy-land/of\"] = createStream\r\n\tstream.valueOf = valueOf, stream.toJSON = toJSON, stream.toString = valueOf\r\n\r\n\tObject.defineProperties(stream, {\r\n\t\tend: {get: function() {\r\n\t\t\tif (!stream._state.endStream) {\r\n\t\t\t\tvar endStream = createStream()\r\n\t\t\t\tendStream.map(function(value) {\r\n\t\t\t\t\tif (value === true) {\r\n\t\t\t\t\t\tunregisterStream(stream)\r\n\t\t\t\t\t\tendStream._state.unregister = function(){unregisterStream(endStream)}\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn value\r\n\t\t\t\t})\r\n\t\t\t\tstream._state.endStream = endStream\r\n\t\t\t}\r\n\t\t\treturn stream._state.endStream\r\n\t\t}}\r\n\t})\r\n}\r\nfunction updateStream(stream, value) {\r\n\tupdateState(stream, value)\r\n\tfor (var id in stream._state.deps) updateDependency(stream._state.deps[id], false)\r\n\tif (stream._state.unregister != null) stream._state.unregister()\r\n\tfinalize(stream)\r\n}\r\nfunction updateState(stream, value) {\r\n\tstream._state.value = value\r\n\tstream._state.changed = true\r\n\tif (stream._state.state !== 2) stream._state.state = 1\r\n}\r\nfunction updateDependency(stream, mustSync) {\r\n\tvar state = stream._state, parents = state.parents\r\n\tif (parents.length > 0 && parents.every(active) && (mustSync || parents.some(changed))) {\r\n\t\tvar value = stream._state.derive()\r\n\t\tif (value === HALT) return false\r\n\t\tupdateState(stream, value)\r\n\t}\r\n}\r\nfunction finalize(stream) {\r\n\tstream._state.changed = false\r\n\tfor (var id in stream._state.deps) stream._state.deps[id]._state.changed = false\r\n}\r\n\r\nfunction combine(fn, streams) {\r\n\tif (!streams.every(valid)) throw new Error(\"Ensure that each item passed to stream.combine/stream.merge is a stream\")\r\n\treturn initDependency(createStream(), streams, function() {\r\n\t\treturn fn.apply(this, streams.concat([streams.filter(changed)]))\r\n\t})\r\n}\r\n\r\nfunction initDependency(dep, streams, derive) {\r\n\tvar state = dep._state\r\n\tstate.derive = derive\r\n\tstate.parents = streams.filter(notEnded)\r\n\r\n\tregisterDependency(dep, state.parents)\r\n\tupdateDependency(dep, true)\r\n\r\n\treturn dep\r\n}\r\nfunction registerDependency(stream, parents) {\r\n\tfor (var i = 0; i < parents.length; i++) {\r\n\t\tparents[i]._state.deps[stream._state.id] = stream\r\n\t\tregisterDependency(stream, parents[i]._state.parents)\r\n\t}\r\n}\r\nfunction unregisterStream(stream) {\r\n\tfor (var i = 0; i < stream._state.parents.length; i++) {\r\n\t\tvar parent = stream._state.parents[i]\r\n\t\tdelete parent._state.deps[stream._state.id]\r\n\t}\r\n\tfor (var id in stream._state.deps) {\r\n\t\tvar dependent = stream._state.deps[id]\r\n\t\tvar index = dependent._state.parents.indexOf(stream)\r\n\t\tif (index > -1) dependent._state.parents.splice(index, 1)\r\n\t}\r\n\tstream._state.state = 2 //ended\r\n\tstream._state.deps = {}\r\n}\r\n\r\nfunction map(fn) {return combine(function(stream) {return fn(stream())}, [this])}\r\nfunction ap(stream) {return combine(function(s1, s2) {return s1()(s2())}, [stream, this])}\r\nfunction valueOf() {return this._state.value}\r\nfunction toJSON() {return this._state.value != null && typeof this._state.value.toJSON === \"function\" ? this._state.value.toJSON() : this._state.value}\r\n\r\nfunction valid(stream) {return stream._state }\r\nfunction active(stream) {return stream._state.state === 1}\r\nfunction changed(stream) {return stream._state.changed}\r\nfunction notEnded(stream) {return stream._state.state !== 2}\r\n\r\nfunction merge(streams) {\r\n\treturn combine(function() {\r\n\t\treturn streams.map(function(s) {return s()})\r\n\t}, streams)\r\n}\r\n\r\nfunction scan(reducer, seed, stream) {\r\n\tvar newStream = combine(function (s) {\r\n\t\treturn seed = reducer(seed, s._state.value)\r\n\t}, [stream])\r\n\r\n\tif (newStream._state.state === 0) newStream(seed)\r\n\r\n\treturn newStream\r\n}\r\n\r\nfunction scanMerge(tuples, seed) {\r\n\tvar streams = tuples.map(function(tuple) {\r\n\t\tvar stream = tuple[0]\r\n\t\tif (stream._state.state === 0) stream(undefined)\r\n\t\treturn stream\r\n\t})\r\n\r\n\tvar newStream = combine(function() {\r\n\t\tvar changed = arguments[arguments.length - 1]\r\n\r\n\t\tstreams.forEach(function(stream, idx) {\r\n\t\t\tif (changed.indexOf(stream) > -1) {\r\n\t\t\t\tseed = tuples[idx][1](seed, stream._state.value)\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\treturn seed\r\n\t}, streams)\r\n\r\n\treturn newStream\r\n}\r\n\r\ncreateStream[\"fantasy-land/of\"] = createStream\r\ncreateStream.merge = merge\r\ncreateStream.combine = combine\r\ncreateStream.scan = scan\r\ncreateStream.scanMerge = scanMerge\r\ncreateStream.HALT = HALT\r\n\r\nif (typeof module !== \"undefined\") module[\"exports\"] = createStream\r\nelse if (typeof window.m === \"function\" && !(\"stream\" in window.m)) window.m.stream = createStream\r\nelse window.m = {stream : createStream}\r\n\r\n}());\r\n","module.exports = css;\n\n/**\n * @arg el DOMElement any dom element\n * @arg obj Object a hash of styleName:value, where the style name may be either css-style or jsStyle (camelCase)\n * @returns void\n *\n * The function applies the styles set in obj to the el\n **/\n\nfunction css(el, obj){\n    var style = el.style;\n\n    if (!obj) return;\n\n    for (var key in obj) style[camelCase(key)] = obj[key];\n\n    function camelCase(str){ \n        return  str.replace(/-([a-z])/g, function (g) { return g[1].toUpperCase(); }); \n    }\n}\n","import _ from 'lodash';\nimport global from './global';\nimport createDB from './task/sequencer/createDB';\nimport canvasSetup from './task/canvas/canvasSetup';\nimport stream from 'mithril-stream';\n\nexport default setup;\n\nfunction setup(canvas, script){\n    var $messages = stream();\n    var $resize = canvasSetup(canvas, _.get(script, 'settings.canvas', {}),$messages);\n    var db = createDB(script);\n    setupVars(script);\n\n    return {\n        db:db, \n        $resize:$resize,\n        $messages: $messages,\n        canvas: canvas,\n        script: script,\n        settings: script.settings || {}\n    };\n}\n\nfunction setupVars(script){\n    // init global\n    var glob = global(global());\n    var name = script.name || 'anonymous minno-time';\n    var current = script.current ? script.current : {};\n\n    current.logs || (current.logs = []); // init logs object\n    glob[name] = glob.current = current; // create local namespace\n}\n","import _ from 'lodash';\nimport adjustCanvas from './adjust_canvas';\nimport applyCanvasStyles from './applyCanvasStyles';\nimport stream from 'mithril-stream';\nimport css from 'minno-css';\n\nexport default setupCanvas;\n\nfunction setupCanvas(canvas, canvasSettings,$messages){\n    canvasSettings || (canvasSettings = {});\n    var $resize = stream();\n\n    if (!_.isElement(canvas)) throw new Error('minno-time: canvas is not a DOM element');\n\n    canvas.classList.add('minno-canvas');\n\n    // apply canvas styles\n    var map = {\n        background \t\t\t: {element: document.body, property: 'backgroundColor'},\n        canvasBackground\t: {element: canvas, property:'backgroundColor'},\n        borderColor\t\t\t: {element: canvas, property:'borderColor'},\n        borderWidth\t\t\t: {element: canvas, property:'borderWidth'}\n    };\n\n    var off = applyCanvasStyles(map, _.pick(canvasSettings,['background','canvasBackground','borderColor','borderWidth']));\n\n    canvasSettings.css && css(canvas, canvasSettings.css);\n\n    // setup canvas resize\n    $resize.map(adjustCanvas(canvas, canvasSettings, $messages));\n    $resize({});\n\n    window.addEventListener('orientationchange', $resize);\n    window.addEventListener('resize', $resize);\n\n    $resize.end\n        .map(function(){canvas.classList.remove('minno-canvas');})\n        .map(function removeListeners(){\n            window.removeEventListener('orientationchange',$resize);\n            window.removeEventListener('resize', $resize);\n        })\n        .map(off);\n\n    return $resize;\n}\n","/*\n * this file is resposible for taking the experiment script (json) and parsing it\n */\n\n// load dependancies\nimport _ from 'lodash';\nimport Database from 'minno-sequencer';\nimport go from './sequenceGoto';\n\nexport default createDB;\n\nfunction createDB(script){\n    var db = new Database();\n    db.createColl('trial');\n    db.createColl('stimulus');\n    db.createColl('media');\n\n    db.add('trial', script.trialSets || []);\n    db.add('stimulus', script.stimulusSets || []);\n    db.add('media', script.mediaSets || []);\n\n    if (!_.isArray(script.sequence)) throw new Error('You must set a sequence array.');\n\n    var sequence = db.sequence('trial', script.sequence);\n    sequence.go = go; // see sequence/goto.js to understand why we are doing this\n    db.currentSequence = sequence;\n    return db;\n}\n","\n/*\n * media preloader\n * TODO: turn into factory, possibly make progress into a stream.\n */\nimport _ from 'lodash';\nexport default loader;\n\nvar srcStack = [];\t\t\t\t// an array holding all our sources\nvar defStack = [];\t\t\t\t// an array holding all the deferreds\nvar stackDone = 0;\t\t\t\t// the number of sources we have completed downloading\nvar images = {};\nvar getText = _.memoize(getXhr);\n\nvar loader = {\n    // loads a single source\n    load: load,\n\n    all: function(){\n        return Promise.all(defStack);\n    },\n\n    progress: function(){\n        return defStack.length ? stackDone/defStack.length : 1;\n    }\n};\n\n// load a single source\nfunction load(src, type){\n    // the source was already loaded\n    if (srcStack.indexOf(src) !== -1) return false;\n\n    // if we haven't loaded this yet\n    var promise = type == 'template' ? getText(src) : getImage(src);\n\n    promise\n        .then(function(){stackDone++;})\n        .then(function(){\n            loader.onload && loader.onload(src);\n        })\n        .catch(function(e){\n            loader.onerror && loader.onerror(e, src);\n        });\n\n    // keep defered and source for later.\n    defStack.push(promise);\n    srcStack.push(src);\n\n    return promise;\n}\n\nfunction getImage(url){\n    return  new Promise(function(resolve, reject){\n        if (_.includes(url, '<%')) return resolve();\n        var el = document.createElement('img');\n        el.onload = resolve;\n        el.onerror = function(){reject(new Error('Image not found: ' + url ));};\n        el.src = url;\n        images[url] = el;\n    });\n}\n\nfunction getXhr(url){\n    return new Promise(function(resolve, reject){\n        var request = new XMLHttpRequest();\n        request.open('GET',url, true);\n        request.onreadystatechange = function() {\n            if (this.readyState === 4) {\n                if (this.status >= 200 && this.status < 400) resolve(this.responseText);\n                else reject(new Error('Template not found:' + url));\n            }\n        };\n        request.send();\n    });\n}\n","/*\n * build the url for this src (add the generic baseUrl)\n */\n\nimport _ from 'lodash';\n\n/**\n * @param baseUrl {String|Object} the base url to prepend\n * @param url {String} the url we are dealing with\n * @param type {String} the type of resource we are dealing with (image or tempmlate) in case we have multiple base urls\n *\n * @returns String built url\n **/\nexport default function buildUrl(baseUrl, url, type){\n    // it this is a dataUrl type of image, we don't need to append the baseurl\n    if (type == 'image' && /^data:image/.test(url)) return url;\n\n    // the base url setting may be either a string, or an object with the type as a field\n    if (_.isObject(baseUrl)) baseUrl = baseUrl[type];\n\n    // make sure base url is set, and add trailing slash if needed\n    if (!baseUrl) baseUrl = '';\n    else if (baseUrl[baseUrl.length-1] != '/') baseUrl += '/';\n\n    return baseUrl + url;\n}\n","/*\n * gets all media that needs preloading and preloads it\n */\n\nimport _ from 'lodash';\nimport preloader from './preloader';\nimport buildUrl from './buildUrl';\n\nexport default preloadScript;\n\nfunction preloadScript(script, baseUrl){\n    getScriptMedia(script).forEach(loadMedia);\n    return preloader;\n\n    function loadMedia(media){\n        if (!_.isUndefined(media.image)) preloader.load(buildUrl(baseUrl, media.image, 'image'),'image');\n        if (!_.isUndefined(media.template)) preloader.load(buildUrl(baseUrl, media.template,'template'),'template');\n    }\n}\n\n/**\n * Iterates over a script and gathers all media\n **/\nexport function getScriptMedia(script){\n    var mediaSets = script.mediaSets;\n    var stimulusSets = _.map(script.stimulusSets, getStimMedia);\n    var trialSets = _.map(script.trialSets, getTrialMedia);\n    var sequence = _.filter(script.sequence,notMixer).map(getTrialMedia);\n    var preload = _.get(script.settings,'preloadImages', []).map(function(url){ return {image:url}; });\n\n    return _.flattenDeep([mediaSets, stimulusSets, trialSets, sequence, preload]).filter(notUndefined);\n} \n\nfunction getTrialMedia(trial){\n    return [\n        _.map(trial.input, function(input){ return input.element; }),\n        _.map(trial.stimuli, getStimMedia),\n        _.map(trial.layout, getStimMedia)\n    ];\n}\n\nfunction getStimMedia(stim){ return stim.media; }\nfunction notMixer(trial){ return !trial.mixer; }\nfunction notUndefined(val){ return !_.isUndefined(val); }\n","import css from 'minno-css';\nimport fastdom from 'fastdom';\nimport stream from 'mithril-stream';\n\nexport default mouseEvents;\n\nfunction mouseEvents(eventName,inputObj, canvas){\n    var $listener = stream();\n    var element = inputObj.element;\n\n    if (element){\n        css(element, inputObj.css);\n        fastdom.mutate(function(){\n            canvas.appendChild(element);\n        });\n    }\n\n    canvas.addEventListener(eventName, clickListener);\n\n    $listener.end.map(removeClickListener);\n    return $listener;\n\n    function clickListener(e){\n        var target = e.target;\n        if (element && element.contains(target)) return $listener(e);\n        if (!element && target.closest('[data-handle=\"' + inputObj.stimHandle + '\"]')) return $listener(e);\n        return;\n    }\n\n    function removeClickListener(){\n        if (element) canvas.removeChild(element);\n        canvas.removeEventListener(eventName, $listener);\n    }\n}\n","/*\n* key pressed listener\n* reqires key\n*\n* key can be either charCode or string.\n* or an array of charCode/strings.\n*/\n\n// we monitor all key up events so that we trigger only once per key down\nimport stream from 'mithril-stream';\nexport default keypressed;\n\nvar keyDownArr = [];\n\ndocument.addEventListener('keyup',function(e){ keyDownArr[e.which] = false; });// unset flag to prevent multi pressing of a key \n\nfunction keypressed(inputObj){\n    var $listener = stream();\n\n    // make sure key is an array\n    var keys = Array.isArray(inputObj.key) ? inputObj.key : [inputObj.key];\n\n    // map keys to keyCodes\n    var target = keys.map(function(value){ \n        return typeof value == 'string' ? value.toUpperCase().charCodeAt(0) : value; \n    });\n\n    document.addEventListener('keydown', keypressListener);\n\n    $listener.end.map(removeKeypressListener);\n    return $listener;\n\n    function keypressListener(e){\n        if (keyDownArr[e.which] || (target.indexOf(e.which) === -1)) return;\n        e.preventDefault(); // prevent FF from wasting about 10ms in browser-content.js (and fast search)\n        keyDownArr[e.which] = true; // set flag to prevent multi pressing of a key\n        $listener(e);\n    }\n\n    function removeKeypressListener(){\n        document.removeEventListener('keydown', keypressListener);\n    }\n}\n","import stream from 'mithril-stream';\nexport default keyup; \n\nfunction keyup(inputObj){\n    var $listener = stream();\n    // make sure key is array\n    var keys = Array.isArray(inputObj.key) ? inputObj.key : [inputObj.key];\n\n    // map keys to keyCodes\n    var target = keys.map(function(value){ \n        return typeof value == 'string' ? value.toUpperCase().charCodeAt(0) : value; \n    });\n\n    document.addEventListener('keyup', keypressListener);\n\n    $listener.end.map(removeKeypressListener);\n    return $listener;\n\n    function keypressListener(e){\n        if (target.indexOf(e.which) === -1) return;\n        e.preventDefault();\n        return $listener(e);\n    }\n\n    function removeKeypressListener(){\n        document.removeEventListener('keyup', $listener);\n    }\n}\n","export default window.performance.now\n    ? window.performance.now.bind(window.performance)\n\n    // We aren't using the absoulte time anywhere so we can use raw Date.now as a replacement\n    // if we're not on IE9\n    : Date.now.bind(Date);\n","import randomize from './simpleRandomize';\nimport stream from 'mithril-stream';\nimport fastdom from 'fastdom';\nimport now from '../now';\n\nexport default timeout;\n\n/*\n * We set timeout to trigger half a frame before the target time.\n * This is done so that on overage we hit as close as possible to the true duration\n * `offset` is updated dynamically by correctOfset() below\n **/\nvar offset = 5;\n\nfunction timeout(inputObj){\n    var $listener = stream();\n    var timeoutID;\n    var duration = randomize(inputObj.duration) || 0;\n    var isCanceled = false;\n\n    $listener.end.map(function(){isCanceled = true;});\n\n    if (!duration) $listener({}); // listener is already registered with $events so this should be immidiate \n\n    else fastdom.measure(function(){\n        // start timeout the same time that current visual stimuli occur\n        var target = now() + +duration - offset;\n        step();\n        function step(){\n            if (isCanceled) return;\n            fastdom.measure(function(){\n                if (now() >= target) $listener({});\n                else fastdom.mutate(step); // we use mutate here so that step does not get called within the same RAF\n            });\n        }\n    });\n\n    return $listener;\n}\n\n\n// compute true frame rate for this specific machine\n// and set offset to half of that\n(function correctOfset(){\n    var itterations = 50;\n    var a,b, results = [];\n    requestAnimationFrame(function(){\n        a = now();\n        update();\n    });\n\n    function update(){\n        requestAnimationFrame(function(){\n            b = now();\n            results.push(b-a)\n            a = b;\n            if (results.length < itterations)  return setTimeout(update);\n            else offset = mean(results)/3; \n            // we want an offset of half of the frame rate, so on average we hit the closest frame possible to the target.\n            // but it turns out that can create fragile balances and a high variance in display length\n            // using an offset of 1/3 we get both improved accuracy (mean closer to target) and improved precission (study number of frames)\n        });   \n    }\n\n    function mean(arr){return arr.reduce(function(v,s){return v+s},0)/arr.length}\n})();\n","/**\n *\tTakes a properties objects and returns the result of a randomization:\n *\tIf it is an array - pick a random member\n *\tIf it is an object pick from within a range\n *\tIf it is a function return its result using the context\n *\tOtherwise simply return the properties\n */\nimport _ from 'lodash';\n\nexport default simpleRandomize;\n\nfunction simpleRandomize(properties, context){\n\n    if (_.isArray(properties)) {\n        var index = Math.floor(Math.random()*properties.length);\n        return properties[index];\n    }\n\n    if (_.isFunction(properties)) {\n        return properties.call(context);\n    }\n\n    // this must be after the test for arrays and functions, because they are considered objects too\n    if (_.isPlainObject(properties)) {\n        if (!_.isNumber(properties.min) || !_.isNumber(properties.max) || properties.min > properties.max) {\n            throw new Error('randomization objects need both a max and a minimum property, also max has to be larger than min');\n        }\n        return properties.min + (properties.max - properties.min) * Math.random();\n    }\n\n    // if this is not a randomization object simply return\n    return properties;\n}\n\n","import binder from './binder';\nimport stream from 'mithril-stream';\nimport _ from 'lodash';\n\nexport default createListener;\n\nfunction createListener(inputObj,canvas){\n    var $listener = getListener(inputObj, canvas);\n\n    if (!isStream($listener)) throw new Error('Input functions must return valid streams: ' + logObj(inputObj));\n    if ('handle' in inputObj) $listener.handle = inputObj.handle;\n\n    return $listener;\n}\n\nfunction getListener(inputObj, canvas){\n    var $listener;\n\n    if (_.isFunction(inputObj)) return inputObj(inputObj, canvas, stream);\n\n    if (_.isPlainObject(inputObj)) {\n        if (_.isString(inputObj.on)) return binder(inputObj,canvas,stream);\n\n        if (_.isFunction(inputObj.on )) {\n            $listener = inputObj.on(inputObj,canvas,stream);\n            if (!$listener || !$listener._state) throw new Error('input.on must return a stream');\n            if (_.isFunction(inputObj.off)) $listener.end.map(inputObj.off);\n            return $listener;\n        }\n    }\n        \n    throw new Error('Input must only contain objects and functions, do you have an undefined value?');\n}\n\nfunction logObj(obj){\n    return _.isFunction(obj) ? obj.toString() : JSON.stringify(obj);\n}\n\n\nfunction isStream(stream) {return stream._state; }\n","\nimport _ from 'lodash';\nimport mouseEvents from './bindings/mouseEvents';\nimport keypressed from './bindings/keypressed';\nimport keyup from './bindings/keyup';\nimport timeout from './bindings/timeout';\nimport css from 'minno-css';\n\nexport default inputBinder;\n\n/**\n * The input binder is a hash of default input types\n * It returns a stream of events\n **/\nfunction inputBinder(inputObj, canvas){\n    var on = inputObj.on; // what type of binding is this?\n\n    switch (on){\n\n        case 'keypressed'\t: return keypressed(inputObj);\n\n        case 'keyup'\t\t: return keyup(inputObj);\n\n        case 'click'\t\t:\n        case 'mousedown'    :\n            return mouseEvents('mousedown', inputObj, canvas);\n\n        case 'mouseup'\t    : return mouseEvents('mouseup', inputObj, canvas);\n\n        case 'mouseover'\t: return mouseEvents('mouseover', inputObj, canvas);\n\n        case 'mouseout'\t: return mouseEvents('mouseout', inputObj, canvas);\n\n        case 'timeout'\t\t: return timeout(inputObj);\n\n        /*\n         * Shortcuts\n         */\n\n        case 'enter'\t: return keypressed(_.assign({key:13},inputObj));\n\n        case 'space'\t: return keypressed(_.assign({key:32},inputObj));\n\n        case 'esc'\t    : return keypressed(_.assign({key:27},inputObj));\n\n        case 'leftTouch'\t:\n            inputObj.element = createElement(inputObj.css, {\n                position: 'absolute',\n                left: 0,\n                width: '30%',\n                height: '100%',\n                background: '#00FF00',\n                opacity: 0.3\n            });\n\n            return mouseEvents('mousedown', inputObj, canvas);\n\n        case 'rightTouch'\t:\n            inputObj.element = createElement(inputObj.css, {\n                position: 'absolute',\n                right: 0,\n                width: '30%',\n                height: '100%',\n                background: '#00FF00',\n                opacity: 0.3\n            });\n\n            return mouseEvents('mousedown', inputObj, canvas);\n\n        case 'topTouch'\t:\n            inputObj.element = createElement(inputObj.css, {\n                position: 'absolute',\n                top: 0,\n                width: '100%',\n                height: '30%',\n                background: '#00FF00',\n                opacity: 0.3\n            });\n\n            return mouseEvents('mousedown', inputObj, canvas);\n\n        case 'bottomTouch'\t:\n            inputObj.element = createElement(inputObj.css, {\n                position: 'absolute',\n                bottom: 0,\n                width: '100%',\n                height: '30%',\n                background: '#00FF00',\n                opacity: 0.3\n            });\n\n            return mouseEvents('mousedown', inputObj, canvas);\n\n        default:\n            throw new Error('You have an input element with an unrecognized \"on\" property: ' + on);\n\n    }\n\n\n    function createElement(css2, css1){\n        var el = document.createElement('div');\n        css(el, css1);\n        css(el, css2);\n        return el;\n    }\n}\n","import createListener from './createListener';\nimport now from './now';\n\nexport default interfaceFn;\n\nfunction interfaceFn($events, canvas){\n    var listenerStack = []; // holds all active listeners\n    var baseTime = 0;\n\n    return { add:add,remove:remove,removeAll:removeAll,resetTimer:resetTimer };\n\n    function add(inputObj){\n        if (!inputObj) throw new Error('Missing input element. Could not add input listener');\n        var $listener = createListener(inputObj, canvas);\n        $listener.map(addDetails).map($events); // pipe events to $events\n        listenerStack.push($listener);\n\n        function addDetails(event){\n            return {\n                handle      : $listener.handle,\n                event       : event,\n                timestamp\t: +new Date(),\n                latency\t\t: now() - baseTime\n            };\n        }\n    }\n\n    function remove(handle){\n        // go through the listener stack and remove any listeners that fit the handle\n        // note that we do this in reverse so that the index does not change\n        for (var i = listenerStack.length - 1; i >= 0 ; i--){\n            var $listener = listenerStack[i];\n            if ($listener.handle === handle){\n                $listener.end(true);\n                listenerStack.splice(i,1);\n            }\n        }\n    }\n\n    function removeAll(){\n        listenerStack.forEach(function($listener){\n            $listener.end(true);\n        });\n        listenerStack.length = 0;\n    }\n\n    function resetTimer(){ baseTime = now(); }\n}\n","import _ from 'lodash';\nexport default getMedia;\n\nfunction getMedia(media, $messages){\n    // all templateing is done within the inflate trial function and the sequencer\n    var template = media.html || media.inlineTemplate || media.template; // give inline template precedence over template, because tempaltes are loaded into inlinetemplate\n    var el;\n\n    if (_.isFunction(media)) return customMedia(media);\n\n    if (isWord(media)) media = {word:media};\n\n    if (isWord(media.word)) {\n        el = document.createElement('div');\n        el.textContent = media.word;\n        return Promise.resolve(el);\n    }\n\n    if (template) { // html | template | inlineTemplate\n        el = document.createElement('div');\n        el.innerHTML = template;\n        return Promise.resolve(el);\n    } \n\n    // at this time, we count on the preloader to throw for errors\n    // the reject option isn't really being used here...\n    if (media.$image) return new Promise(function(resolve, reject){\n        var startTime = performance.now();\n        var src = media.$image;\n        el = document.createElement('img');\n        el.onload = function(){\n            var latency = performance.now() - startTime ;\n            if (latency > 16) $messages({\n                type:'warn',\n                message: 'It took too long to load \"' + src + '\" (' + latency +'ms). Make sure that it was preloaded properly.',\n                context:src\n            });\n            resolve(el);\n        };\n        el.onerror = function(){reject(new Error('Image not found: ' + el.src ));};\n        el.src = src;\n    });\n\n    if (media.jquery) return Promise.reject(new Error('Jquery is no longer supported in minno-time'));\n\n    return Promise.reject(new Error('Unrecognized media type')); // this is not a supported html type\n}\n\nfunction isWord(val){ return _.isString(val) || _.isNumber(val); }\n\nfunction customMedia(media){\n    var promise = media();\n    if (!isThenable(promise)) return Promise.reject(new Error('Custom media must return a promise'));\n    return promise.then(forceElement);\n\n    function isThenable(p){ return p && _.isFunction(p.then); }\n    function forceElement(el){ return _.isElement(el) ? el : Promise.reject('Custom media must resolve with an element');}\n}\n","import _ from 'lodash';\nexport default setSize;\n\nfunction setSize(el,stimulus){\n    var style = el.style;\n    var size = stimulus.size || {};\n\n    if (size.font_size) style.fontSize = size.font_size;\n\n    // if this is a word, we don't want to set height (it breaks centering)\n    if (isSet('height', size) && !isWordMedia(stimulus.media)) style.height = size.height + '%';\n\n    if (isSet('width', size)) style.width = size.width + '%';\n\n    return el;\n}\n\nfunction isSet(prop, obj){return prop in obj;}\nfunction isWordMedia(media){ return _.isString(media) || _.isString(media.word); }\n\n","export default setPlace;\n\nfunction setPlace(el,stimulus){\n    var location = stimulus.location || {};\n\n    ['top','bottom','left','right'].forEach(setNumericLocation);\n\n    function isNumeric(val) {return !isNaN(+val);}\n    function setNumericLocation(attr){ if (isNumeric(location[attr])) el.style[attr] = location[attr] + '%'; }\n}\n","import fastdom from 'fastdom';\nimport setSize from './setSize';\nimport setPlace from './setPlace';\nimport css from 'minno-css';\nvar isIE = window.document.documentMode;\n\nexport default setupElement;\n\nfunction setupElement(stimulus, index, el){\n    var canvas = stimulus.canvas;\n\n    stimulus.el = el;\n    return new Promise(function(resolve){\n        fastdom.mutate(function initStim(){\n            // setup element\n            el.classList.add('minno-stimulus');\n            el.setAttribute('data-handle', stimulus.handle); // data-handle for handeling of mouse/touch interactions\n            el.style.zIndex = index*10; // make sure elements are layered correctly (becuase sometimes they are not linearly inserted into the dom).\n            canvas.appendChild(el);\n\n            setSize(el, stimulus.source);\n            setPlace(el, stimulus.source);\n            css(el, stimulus.source.css || {});\n\n            if (!isIE) {\n                if (stimulus.source.isLayout) el.classList.add('minno-stimulus-visible');\n                resolve(el);\n            }\n            else fixIE(stimulus, resolve);\n        });\n    });\n}\n\n/**\n * sets element dimensions explicitly so that centering works in ie\n **/\nfunction fixIE(stimulus, resolve){\n    var canvas = stimulus.canvas;\n    var el = stimulus.el;\n    var location = stimulus.source.location || {};\n\n    fastdom.measure(function(){\n        var width = (100 * el.clientWidth / canvas.clientWidth);\n        var height = (100 * el.clientHeight / canvas.clientHeight);\n        fastdom.mutate(function(){\n            var style = el.style;\n            style.width = width + '%';\n            style.height = height + '%';\n            if (testProps(location.top, location.bottom)) { style.top = (100-height)/2+'%'; }\n            if (testProps(location.left, location.right)) { style.left = (100-width)/2+'%'; }\n            if (stimulus.source.isLayout) el.classList.add('minno-stimulus-visible');\n            resolve(el);\n        });\n    });\n\n    function testProps(p1, p2){\n        return p1 === 'center' || p2 === 'center' || (p1 === undefined && p2 === undefined);\n    }\n}\n","import fastdom from 'fastdom';\nimport getMedia from './getMedia';\nimport setupElement from './setupElement';\n\nexport default Stimulus;\n\nfunction Stimulus(stimulus, trial, canvas){\n    var self = {\n        el: null, // is set within init, some methods will break if not called before init...\n        source: stimulus,\n        trial: trial,\n        canvas: canvas,\n        init: init,\n        show: show,\n        hide: hide,\n        name: name,\n        mediaName: mediaName,\n        destroy: destroy\n    };\n\n    // make sure we have a data object\n    self.data = stimulus.data || {};\n\n    // set the handle\n    self.handle = self.data.handle = self.data.handle || stimulus.handle || stimulus.set;\n\n    return self;\n}\n\n\nfunction init(index){\n    var stimulus = this;\n    var source = this.source;\n    var $messages = this.trial.$messages;\n    if (!this.source.media) throw new Error('Media object not defined for ' + this.name());\n\n    return getMedia(this.source.media, $messages)\n        .then(setupElement.bind(null, stimulus, index))\n        .catch(onError);\n\n    function onError(error){\n        $messages({type:'error', message: 'trial.stimulus error', error:error, context:source});\n        throw error;\n    }\n}\n\nfunction show(){\n    var el = this.el;\n    if (!el) throw new Error('A stimulus can not be shown before init is called');\n\n    fastdom.mutate(function showStim(){\n        el.classList.add('minno-stimulus-visible');\n    });\n}\n\nfunction hide(){\n    var el = this.el;\n    if (!el) throw new Error('A stimulus can not be hidden before init is called');\n\n    fastdom.mutate(function hideStim(){\n        el.classList.remove('minno-stimulus-visible');\n    });\n}\n\nfunction destroy(){\n    var el = this.el;\n    var canvas = this.canvas;\n    fastdom.mutate(function removeStim(){\n        canvas.removeChild(el);\n    });\n}\n\nfunction name(){\n    var source = this.source;\n    // if we have an alias ues it\n    if (source.alias) {return source.alias;}\n    if (this.data && this.data.alias) {return this.data.alias;} // if we have an alias ues it\n\n    if (source.inherit && source.inherit.set) {return source.inherit.set;} // otherwise try using the set we inherited from\n    if (this.handle) {return this.handle;} // otherwise use handle\n\n    // if no individual name is given, we set a default at the collection level\n}\n\nfunction mediaName(options){\n    var media = this.source.media;\n    var fullpath = options && options.fullpath; // as set within settings\n\n    if (media.alias) {return media.alias;} // if we have an alias ues it\n    if (media.data && media.data.alias) { return media.data.alias; }\n\n    for (var prop in media) {\n        if (contains(['image','template'],prop)) return fullpath ? media[prop] : media[prop].replace(/^.*[\\\\/]/, '');\n\n        // sometimes we have an empty value (this happens when we load a template and then translate it into an inline template)\n        if (contains(['word','html','inlineTemplate'],prop) && media[prop]) return media[prop];\n    }\n\n    // if no individual name is given, we set a default at the collection level\n}\n\nfunction contains(arr, val){ return arr.indexOf(val) != -1;}\n","import Stimulus from './Stimulus';\nimport _ from 'lodash';\n\nexport default stimCollection;\n\nfunction stimCollection(trial, canvas){\n    validateStimuli('stimuli', trial._source);\n    validateStimuli('layout', trial._source);\n\n    var source = trial._source;\n    var stimuli = _.map(source.stimuli, toStim);\n    var layout = _.map(source.layout, toLayout).map(toStim);\n    var stimReady = stimuli.concat(layout).map(function(stim,index){return stim.init(index);});\n\n    var self = {\n        canvas: canvas,\n        stimuli: stimuli,\n        layout: layout,\n        ready: Promise.all(stimReady),\n        getStimlist: getStimlist,\n        getMedialist: getMedialist,\n        destroy: destroy\n    };\n\n    return self;\n\n    function toStim(stim){ return Stimulus(stim, trial, canvas); }\n    function toLayout(stim){ stim.isLayout = true; return stim;}\n}\n\nfunction getStimlist(){\n    return this.stimuli\n        .filter(function(stim){return !stim.source.nolog;})\n        .map(function(stim, index){return stim.name() || ('stim' + index);});\n}\n\nfunction getMedialist(options){\n    return this.stimuli\n        .filter(function(stim){return !stim.source.nolog;})\n        .map(function(stim, index){return stim.mediaName(options) || ('media' + index);});\n}\n\nfunction destroy(){\n    this.stimuli.concat(this.layout).forEach(function(stim){stim.destroy();});\n}\n\nexport function validateStimuli(type, source){\n    var stimuli = source[type];\n    if (!stimuli) return;\n    if (!Array.isArray(stimuli)) throw new Error(type + ' must be an array');\n    if (!stimuli.every(function(stim){ return 'media' in stim; })) throw new Error('Each ' + type + ' stimulus must have a media property');\n}\n","import _ from 'lodash';\nimport globalGetter from '../../global';\n\nvar global = globalGetter();\nvar conditionHash = {\n    begin:begin,\n    inputEquals:inputEquals,\n    inputEqualsTrial:inputEqualsTrial,\n    inputEqualsStim:inputEqualsStim,\n    trialEquals:trialEquals,\n    inputEqualsGlobal:inputEqualsGlobal,\n    globalEquals:globalEquals,\n    globalEqualsTrial:globalEqualsTrial,\n    globalEqualsStim:globalEqualsStim,\n    currentEquals:currentEquals,\n    currentEqualsTrial:currentEqualsTrial,\n    currentEqualsStim:currentEqualsStim,\n    inputEqualsCurrent:inputEqualsCurrent,\n    fn:fn,\n    custom:custom,\n};\n\nexport default function getConditonFn(condition){\n    if (_.isFunction(condition)) return condition;\n    if (_.isFunction(conditionHash[condition.type])) return conditionHash[condition.type];\n    throw new Error('Unknown condition type: ' + JSON.stringify(condition));\n}\n\nfunction begin(inputData){ return inputData.type === 'begin'; }\n\nfunction inputEquals(inputData, condition){\n    var values = Array.isArray(condition.value) ? condition.value : [condition.value];\n    return values.indexOf(inputData.handle) !== -1;\n}\n\nfunction inputEqualsTrial(inputData, condition, trial){ return inputData.handle === trial.data[condition.property]; }\n\nfunction inputEqualsStim(inputData, condition, trial){\n    // create search object\n    var searchObj = {};\n    if (condition.handle) searchObj['handle'] = condition.handle;\n    searchObj[condition.property] = inputData.handle;\n\n    // are there stimuli answering this descriptions?\n    return hasData(searchObj,trial);\n}\n\nfunction trialEquals(inputData, condition, trial){\n    if (_.isUndefined(condition.property) || _.isUndefined(condition.value)) throw new Error('trialEquals requires both \"property\" and \"value\" to be defined');\n    return condition.value === trial.data[condition.property];\n}\n\nfunction inputEqualsGlobal(inputData, condition){\n    if (_.isUndefined(condition.property)) throw new Error('inputEqualsGlobal requires \"property\" to be defined');\n    return inputData.handle === global[condition.property];\n}\n\nfunction globalEquals(inputData, condition){\n    if (typeof condition.property == 'undefined' || typeof condition.value == 'undefined') throw new Error('globalEquals requires both \"property\" and \"value\" to be defined');\n    return condition.value === global[condition.property];\n}\n\nfunction globalEqualsTrial(inputData, condition, trial){\n    if (typeof condition.globalProp == 'undefined' || typeof condition.trialProp == 'undefined') throw new Error('globalEqualsTrial requires both \"globalProp\" and \"trialProp\" to be defined');\n    return global[condition.globalProp] === trial.data[condition.trialProp];\n}\n\nfunction globalEqualsStim(inputData, condition, trial){\n    if (typeof condition.globalProp == 'undefined' || typeof condition.stimProp == 'undefined') throw new Error('globalEqualsStim requires both \"globalProp\" and \"stimProp\" to be defined');\n\n    // create search object\n    var searchObj = {};\n    if (condition.handle) searchObj['handle'] = condition.handle;\n    searchObj[condition.stimProp] = global[condition.globalProp];\n\n    // are there stimuli answering this descriptions?\n    return hasData(searchObj,trial);\n}\n\nfunction inputEqualsCurrent(inputData, condition){\n    var current = global.current;\n    if (typeof condition.property == 'undefined') throw new Error('inputEqualsCurrent requires \"property\" to be defined');\n    return inputData.handle === current[condition.property];\n}\nfunction currentEquals(inputData, condition){\n    var current = global.current;\n    if (typeof condition.property == 'undefined' || typeof condition.value == 'undefined') throw new Error('currentEquals requires both \"property\" and \"value\" to be defined');\n    return condition.value === current[condition.property];\n}\n\nfunction currentEqualsTrial(inputData, condition, trial){\n    var current = global.current;\n    if (typeof condition.currentProp == 'undefined' || typeof condition.trialProp == 'undefined') throw new Error('currentEqualsTrial requires both \"currentProp\" and \"trialProp\" to be defined');\n    return current[condition.currentProp] === trial.data[condition.trialProp];\n}\n\nfunction currentEqualsStim(inputData, condition, trial){\n    var current = global.current;\n    if (typeof condition.currentProp == 'undefined' || typeof condition.stimProp == 'undefined') throw new Error('currentEqualsStim requires both \"currentProp\" and \"stimProp\" to be defined');\n\n    // create search object\n    var searchObj = {};\n    if (condition.handle) searchObj['handle'] = condition.handle;\n    searchObj[condition.stimProp] = current[condition.currentProp];\n\n    // are there stimuli answering this descriptions?\n    return hasData(searchObj, trial);\n}\n\nfunction fn(inputData, condition, trial){\n    return condition.value.apply(trial,[condition,inputData, trial]);\n}\n\nfunction custom(inputData, condition, trial){\n    return condition.fn.apply(null, [condition, inputData, trial]);\n}\n\nfunction hasData(searchObj, trial){\n    return trial.stimulusCollection.stimuli.some(function(stim){\n        var data = stim.data;\n        for (var key in searchObj) {\n            if (searchObj[key] !== data[key]) return false;\n        }\n        return true;\n    });\n}\n","/*\n * gets a condition array (or a single condition) and evaluates it\n * returns true if all statements are true, false otherwise\n *\n * a single condition looks like this:\n *\n *\tcondition = {\n *\t\ttype : 'begin/inputEquals/inputEqualsTrial/inputEqualsStim/function',\n *\t\tvalue: 'right/trialAttribute/stimAttribute/customFunction',\n *\t\thandle: 'stim handle' (optional in case we're targeting a stimulus)\n *\t}\n *\n */\n\nimport getConditionFn from './getConditionFn';\n\nexport default conditionsEvaluate;\n\nfunction conditionsEvaluate(conditions, inputData, trial){\n    // make sure conditions is an array\n    conditions = Array.isArray(conditions) ? conditions : [conditions];\n\n    // do not activate empty condition arrays\n    if (!conditions.length) return false;\n\n    // if this is a begin event, make sure we only run interactions that have begin in them\n    if (inputData.type == 'begin' && conditions.every(function(condition){return condition.type != 'begin';})) return false;\n\n    return conditions.every(checkCondition);\n\n\n    function checkCondition(condition){\n        var value = getConditionFn(condition)(inputData, condition, trial);\n        return condition.negate ? !value : value;\n    }\n}\n","import _ from 'lodash';\nimport fastdom from 'fastdom';\nimport global from '../../global';\nimport applyCanvasStyles from '../../task/canvas/applyCanvasStyles';\n\nexport default actions;\n\n// @TODO: see if we can afford to change the signature of actions\n// I'd like to have the trial go first here (used almost always).\nvar actions = {\n    /*\n     * Stimulus actions\n     */\n    showStim: function(action, eventData, trial){\n        var handle = action.handle || action;\n        trial.stimulusCollection.stimuli.forEach(function(stim){\n            if (handle == 'All' || stim.handle == handle) stim.show();\n        });\n    },\n\n    hideStim: function(action, eventData, trial){\n        var handle = action.handle || action;\n        trial.stimulusCollection.stimuli.forEach(function(stim){\n            if (handle == 'All' || stim.handle == handle) stim.hide();\n        });\n    },\n\n    setStimAttr: function(action, eventData, trial){\n        var handle = action.handle;\n        var setter = action.setter;\n        trial.stimulusCollection.stimuli.forEach(function(stim){\n            if (handle == 'All' || stim.handle == handle) {\n                if (_.isFunction(setter)) setter.apply(stim);\n                else _.extend(stim.data, setter);\n            }\n        });\n    },\n\n    /*\n     * Trial actions\n     */\n    setTrialAttr: function(action, eventData, trial){\n        var setter = action.setter;\n        if (typeof setter == 'undefined') throw new Error('The setTrialAttr action requires a setter property');\n        if (_.isFunction(setter)) setter.apply(trial, [trial.data,eventData]);\n        else _.extend(trial.data,setter);\n    },\n\n    setInput: function(action, eventData, trial){\n        if (typeof action.input == 'undefined') throw new Error('The setInput action requires an input property');\n        trial.input.add(action.input);\n    },\n\n    trigger: function(action, eventData, trial){\n        if (typeof action.handle == 'undefined') throw new Error('The trigger action requires a handle property');\n        trial.input.add({handle:action.handle, on:'timeout', duration:+action.duration || 0});\n    },\n\n    removeInput: function(action, eventData, trial){\n        var input = trial.input;\n        var handleList = action.handle;\n        if (typeof handleList == 'undefined') throw new Error('The removeInput action requires a handle property');\n        if (!Array.isArray(handleList)) handleList = [handleList];\n        if (_.includes(handleList,'All')) input.removeAll();\n        else handleList.forEach(input.remove);\n    },\n\n    goto: function(action, eventData, trial){\n        trial._next = [action.destination,action.properties];\n    },\n\n    endTrial: function(){\n        // this is explicitly managed in interaction.js\n        // in order to improve trial lifecycle control\n    },\n\n    resetTimer: function(action,eventData,trial){\n        // when to reset timer\n        action.immidiate ? reset() :  fastdom.mutate(reset);\n\n        function reset(){\n            eventData.latency = 0;\n            trial.input.resetTimer();\n        }\n    },\n\n    /*\n     * Logger\n     */\n\n    log: function(action,eventData,trial){\n        trial.$logs(arguments);\n    },\n\n    /*\n     * Misc\n     */\n\n    setGlobalAttr: function(action){\n        switch (typeof action.setter){\n            case 'function':\n                action.setter.apply(null,[global(), action]);\n                break;\n            case 'object':\n                _.extend(global(), action.setter);\n                break;\n            default:\n                throw new Error('setGlobalAttr requires a \"setter\" property');\n        }\n    },\n\n    custom: function(action,eventData, trial){\n        if (typeof action.fn != 'function') throw new Error('The custom action requires a fn propery');\n        action.fn(action, eventData, trial);\n    },\n\n    canvas: function(action, eventData, trial){\n        var canvas = trial.cavnas;\n        var map = {\n            background \t\t\t: {element: document.body, property: 'backgroundColor'},\n            canvasBackground\t: {element: canvas, property:'backgroundColor'},\n            borderColor\t\t\t: {element: canvas, property:'borderColor'},\n            borderWidth\t\t\t: {element: canvas, property:'borderWidth'}\n        };\n\n        // settings activator\n        var off = applyCanvasStyles(map, _.pick(action,['background','canvasBackground','borderColor','borderWidth']));\n        trial.$end.map(off);\n    },\n\n    /*\n     *  Mouse tracking\n     */\n    startMouseTracking: function(action, eventData, trial){\n        if (trial.data.listener) return trial.$message({ type:'warn', message: 'Mouse tracking has already been activated.' });\n\n        var startTime = performance.now();\n        var canvas = trial.canvas;// get its computed style\n        var logAs = action.logAs || 'mousetracker';\n\n        // get canvas borders so that we can compute relative to the content box\n        var styling = getComputedStyle(canvas);\n        var topBorder = parseInt(styling.getPropertyValue('border-top-width'));\n        var leftBorder = parseInt(styling.getPropertyValue('border-left-width'));\n\n        var trackedStimuli = trial.stimulusCollection.stimuli.filter(function(stim){ return _.includes(action.logStimulusLocation, stim.handle); });\n\n        var listener = _.throttle(function(e){\n            var canvasLocation = canvas.getBoundingClientRect();\n            var correctedCanvas = {x:canvasLocation.x+leftBorder, y:canvasLocation.y+topBorder};\n            var mouseLocation = { mouseX: e.clientX - correctedCanvas.x, mouseY: e.clientY - correctedCanvas.y };\n\n            var locations = trackedStimuli.reduce(function(acc, val){\n                var rect = val.el.getBoundingClientRect();\n                _.set(acc, val.handle+'X',rect.x - correctedCanvas.x);\n                _.set(acc, val.handle+'Y',rect.y - correctedCanvas.y);\n                _.set(acc, val.handle+'Width',rect.width);\n                _.set(acc, val.handle+'Height',rect.height);\n                return acc;\n            }, mouseLocation);\n\n            var results = _.mapValues(_.set(locations, 'time', performance.now()-startTime), Math.round);\n\n            trial.data[logAs].push(results);\n        }, action.logRate || 15);\n\n        trial.data[logAs] || (trial.data[logAs] = []);\n        trial.data.$listener = listener;\n\n        document.addEventListener('mousemove', listener);\n        trial.$events.end.map(function(){ // make sure that the listener is removed at the end of the trial\n            document.removeEventListener('mousemove', listener);\n        });\n    },\n\n\n    stopMouseTracking: function(e, ed, trial){\n        if (_.isFunction(trial.data.$listener)) { \n            document.removeEventListener('mousemove', trial.data.$listener);\n            trial.data.$listener = undefined; // should be undefined so that JSON.stringify does not encode it\n        }\n    }\n};\n\n","/*\n* Organizer for the interaction function\n*/\n\nimport evaluate from './conditionsEvaluate';\nimport activate from './action';\nimport _ from 'lodash';\n\nexport default interactions;\n\n/*\n * Trial -> Event -> Event\n *\n * Can use trial to produce side efects\n **/\n\nvar MAX_RECURSION_DEPTH = 50;\nfunction interactions(trial){\n    var recursionDepth = 0;\n    var interactions = trial._source.interactions;\n\n    try {\n        validateInteractions(interactions);\n    } catch(error){\n        trial.$messages({type:'error', message: 'trial.interactions error', error:error, context:trial._source});\n        throw error;\n    }\n    return eventMap;\n\n    function eventMap(event){\n        var i, interaction, conditionTrue, endTrial;\n        var groupName = 'Event: ' + (event.handle || event.type);\n        var debugLog = [];\n\n        if (recursionDepth > MAX_RECURSION_DEPTH) throw new Error('It seem you have created an infinite loop. Minno has been halted');\n\n        recursionDepth++;\n        try{\n            // use an explicit for loop because we need to be able to break\n            for (i=0; i<interactions.length; i++){\n                interaction = interactions[i];\n\n                conditionTrue = evaluate(interaction.conditions, event, trial);\n                debugLog.push([conditionTrue, interaction.conditions]);\n\n                if (conditionTrue) endTrial = activate(interaction.actions, event, trial);\n\n                // if this action includes endTrial we want to stop evalutation immidiately\n                if (endTrial) break;\n            }\n\n        } catch(error){\n            trial.$messages({type:'error', message: 'trial.interactions error', error:error});\n            throw error;\n        }\n        recursionDepth--;\n\n        trial.$messages({type:'debug', message: groupName, rows: debugLog});\n\n        // this is here and not within actions so that messages can be sent befor ending the trial\n        if (endTrial) trial.end();\n\n        return event;\n    }\n}\n\nexport function validateInteractions(interactions){\n    if (!Array.isArray(interactions)) throw new Error('Interactions must be an array');\n    if (!interactions.length) throw new Error('There are no interactions defined');\n\n    if (!interactions.every(_.isPlainObject)) throw new Error('Interactions must be plain objects');\n    if (!interactions.every(isValidProp('conditions'))) throw new Error('Conditions must be either an array or a function');\n    if (!interactions.every(isValidProp('actions'))) throw new Error('Actions must be either an array or a function');\n\n    function isValidProp(prop){\n        return function(interaction) {\n            return Array.isArray(interaction[prop]) || _.isFunction(interaction[prop]);\n        };\n    }\n}\n\n","/*\n * accepts an array of actions (or a single action)\n * and applies them\n *\n * actions = [\n *\t\t{type:actionName,more:options},\n *\t\t{actionName:options}\n * ]\n * @param actions: single action object or array of action objects\n * @param eventData: eventData object\n * @returns Boolean: endTrial whether this action stops further action activations\n */\n\nimport _ from 'lodash';\nimport actionList from './actionList';\n\nexport default applyActions;\n\nfunction applyActions(actions, eventData, trial){\n    // marks whether this is the final action to take\n    var endTrial = false;\n\n    actions = _.isArray(actions) ? actions : [actions];\n\n    _.forEach(actions,function(action){\n        var actionFn = _.isFunction(action) ? action : actionList[action.type];\n        if (!actionFn) throw new Error('unknown action: ' + action.type);\n\n        // the only reason to halt action activation is the endTrial command\n        if (action.type === 'endTrial') endTrial = true;\n        actionFn(action, eventData, trial);\n    });\n\n    return endTrial;\n}\n","import _ from 'lodash';\nimport input from './input/input';\nimport stimulusCollection from './stimulus/stimulusCollection';\nimport interactions from './interactions/interactions';\nimport stream from 'mithril-stream';\n\nexport default Trial;\n\nvar gid = 0;\n\n// data is already fully inflated\nfunction Trial(source, canvas, settings){\n    // make sure we have all our stuff :)\n    if (!source.interactions) throw new Error('Interactions not defined');\n\n    this.canvas = canvas;\n    this.settings = settings;\n    this._source = source;\n\n    this.$logs = stream();\n    this.$messages = stream();\n    this.$events = stream();\n    this.$end = this.$events.end;\n\n    // make sure we always have a data container\n    this.data = source.data || {};\n\n    // create a uniqueId for this trial\n    this._id = _.uniqueId('trial_');\n    this.counter = gid++;\n\n    this.input = input(this.$events, canvas);\n    this.stimulusCollection = stimulusCollection(this, canvas);\n\n    // the next trial we want to play\n    // by default this is simply the next trial, this can be changed using the goto action\n    // the syntax is [destination, properties]\n    this._next = ['next',{}];\n}\n\n_.extend(Trial.prototype,{\n    start: function(){\n        var trial = this;\n\n        // wait until all simuli are loaded\n        return trial.stimulusCollection.ready.then(function(){\n            // listen for interactions\n            trial.$events\n                .map(addTrialDetails(trial))\n                .map(interactions(trial));\n\n            // activate input\n            _.forEach(trial._source.input, trial.input.add); // add each input\n            trial.input.resetTimer(); // reset the interface timer so that event latencies are relative to now.\n            // start running\n            trial.$events({type:'begin',latency:0});\n        });\n    },\n\n    end: function(){\n        // remove all listeners\n        this.input.removeAll();\n        this.$end(true);\n    },\n\n    name: function(){\n        // if we have an alias ues it\n        if (this.alias) { return this.alias; }\n        if (this.data.alias) { return this.data.alias; }\n\n        // otherwise try using the set we inherited from\n        if (_.isString(this._source.inherit)) return this._source.inherit;\n        if (_.isPlainObject(this._source.inherit)) return this._source.inherit.set;\n\n        // we're out of options here\n    }\n});\n\nfunction addTrialDetails(trial){\n    return function(event){\n        return _.assign(event, {\n            trialId     : trial._id,\n            counter     : trial.counter\n        });\n    };\n}\n","import _ from 'lodash';\n\nexport default transformLogs;\n\nfunction transformLogs(action,eventData,trial){\n    var global = window.piGlobal;\n    var trialData = trial.data, inputData = eventData, logStack = global.current.logs;\n    var fullpath = _.get(trial, 'settings.logger.fullpath', false);\n\n    var stimList = trial.stimulusCollection.getStimlist();\n    var mediaList = trial.stimulusCollection.getMedialist({fullpath:fullpath});\n\n    return {\n        log_serial : logStack.length,\n        trial_id: trial.counter,\n        name: trial.name(),\n        responseHandle: inputData.handle,\n        latency: Math.floor(inputData.latency),\n        stimuli: stimList,\n        media: mediaList,\n        data: trialData\n    };\n}\n","import _ from 'lodash';\nimport stream from 'mithril-stream';\n\nimport Trial from './trial/Trial';\nimport nextTrial from './task/sequencer/nextTrial';\nimport createLogs from './task/logger/createLogStream';\nimport defaultLogMap from './task/logger/defaultLogMap';\nimport piGlobal from './global';\n\nexport default playerPhase;\n\n/**\n * run the task\n * Essentialy wiring up all the play phase stuff\n * @TODO: document this function, it's super complicated\n **/\n\nfunction playerPhase(sink){\n\n    var canvas = sink.canvas;\n    var db = sink.db;\n    var settings = sink.settings;\n    var global = piGlobal();\n\n    var $source = stream(); // a stream of trial POJO\n    var $trial = $source.map(activateTrial());\n    var $sourceLogs = stream();\n    var $logs = createLogs($sourceLogs, composeLoggerSettings(sink.script, global), defaultLogMap);\n    var onDone = _.get(settings, 'hooks.endTask', settings.onEnd || _.noop);\n\n    var kill; // placeholder for promise resolve\n    var promise = new Promise(function(resolve){ kill = resolve; })\n        .then($source.end.bind(null,true))\n        .then(clearCanvas)\n        .then(onDone);\n\n    // expose logs on current\n    $logs.map(function(log){\n        global.current.logs.push(log);        \n    });\n\n    $source.end\n        .map($trial.end)\n        .map($sourceLogs.end);\n\n    return _.extend({\n        $trial:$trial, \n        $logs: $logs,\n        start: play.bind(null, ['next', {}]),\n        end: kill,\n        promise: promise\n    }, sink);\n\n    function clearCanvas(){\n        var trial = $trial();\n        if (trial) trial.stimulusCollection.destroy();\n    }\n\n    function play(goto){\n        var next = nextTrial(db, settings, goto);\n        if (next.done) kill();\n        else $source(next.value);\n    }\n\n    function activateTrial(cache){\n        return activate;\n        function activate(source){\n            var oldTrial = cache;\n            var trial = cache = new Trial(source, canvas, settings);\n            // pipe public streams to trial streams\n            trial.$logs.map($sourceLogs); \n            trial.$messages.map(sink.$messages); \n\n            // must be *before* the subscription to $end for the next trial\n            if (source.DEBUG && window.DEBUG) setupDebug(trial);\n\n            trial.$end.map(function(){\n                play(trial._next); // when we're done try to play the next one\n            });\n\n            trial.start();\n\n            // we leave the old stimuli until the current ones are ready to maintain the continuity between trials\n            if (oldTrial) trial.stimulusCollection.ready.then(function(){\n                oldTrial.stimulusCollection.destroy();\n            });\n\n            return trial;\n        }\n    }\n}\n\nfunction setupDebug(trial){\n    /* eslint-disable no-console */\n    var trialName = 'Trial :' + trial.counter;\n    console.group(trialName);\n    trial.$messages.map(debugLog);\n    trial.$events.end.map(function(){ console.groupEnd(trialName); });\n\n    function debugLog(log){\n        if (log.type !== 'debug') return log;\n        if (log.rows){\n            console.groupCollapsed(log.message);\n            log.rows.forEach(function(row){ console.log.apply(console, row); });\n            console.groupEnd(log.message);\n        }\n        else console.log(log.message);\n        return log;\n    }\n    /* eslint-enable no-console */\n}\n\n// create metaDeta to add to post\nexport function composeLoggerSettings(script, global){\n    var loggerSettings = _.assign({}, _.get(script, 'settings.logger'));\n    var metaData = _.assign({taskName:script.name}, global.$meta, loggerSettings.metaData);\n    loggerSettings.metaData = metaData;\n    return loggerSettings;\n}\n","export default createLogs;\n\nfunction createLogs($sourceLogs, settings, defaultLogMap){\n    var logMap = settings.logger || settings.logMap || defaultLogMap;\n    return  $sourceLogs.map(applyMap(logMap));\n\n    // $logs is a stream of arrays, we want to apply them as args to the transform function\n    function applyMap(fn){\n        return function(args){ return fn.apply(null,args); };\n    }\n}\n","import _ from 'lodash';\nimport globalGetter from '../../global';\nimport buildUrl from './buildUrl';\n\nexport default nextTrial;\n\nfunction nextTrial(db, settings, goto){\n    var destination = goto[0], properties = goto[1];\n    var sequence = db.currentSequence;\n    var global = globalGetter();\n    var context = {global: global, current: global.current};\n    var source;\n\n    sequence.go(destination, properties, context);\n    source = sequence.current(context, {skip:['layout','stimuli']});\n    source = _.clone(source);\n\n    if (!source) return {done:true};\n\n    context.trialData = source.data;\n    context.trialMeta = source.$meta;\n\n    source.stimuli = _.map(source.stimuli || [], buildStim.bind(context));\n    source.layout = _.map(source.layout || [], buildStim.bind(context));\n\n    return {value:source};\n\n    function buildMedia(stim, prop, context){\n        var val = stim[prop];\n\n        if (_.isUndefined(val)) return false;\n        if (_.isString(val) || _.isNumber(val)) val = {word: val};\n\n        val = db.inflate('media', val, context);\n\n        // note that the base url is added to the media object during the sequence preload\n        // if needed, build url\n        if (val.image) val.$image = buildUrl(settings.base_url, val.image, 'image');\n\n        if (val.template){\n            // @TODO: remove dependency on requirejs\n            val.inlineTemplate = requirejs('text!' + buildUrl(settings.base_url, val.template, 'template'));\n            val.inlineTemplate = _.template(val.inlineTemplate)(context);\n        }\n\n        stim[prop] = val;\n\n        context.mediaData = null;\n        context.mediaMeta = null;\n    }\n\n    function buildStim(stim){\n        var context = this;\n\n        stim = db.inflate('stimulus', stim, context, {skip:['media','touchMedia']});\n        stim = _.clone(stim);\n        buildMedia(stim, 'media', context);\n        buildMedia(stim, 'touchMedia', context);\n        context.stimulusData = null;\n        context.stimulusMeta = null;\n        return stim;\n    }\n}\n","import './polyfills';\nimport './time.css';\n\nimport setup from './app/setup';\nimport preloadPhase from './app/preloadPhase';\nimport playPhase from './app/playPhase';\n\nexport default activate;\n\n/**\n * activate : (HTMLelement, timeScript) -> Sink\n *\n * timeScript : {settings, sequence, trialSets, stimulusSets, mediaSets, current}\n * Sink: {$trial, $logs, play, end}\n **/\nfunction activate(canvas, script){\n    var sink = setup(canvas, script);\n    var playSink = playPhase(sink);\n\n    playSink.$trial.end.map(playSink.$resize.end); // end resize stream\n\n    // preload Images, then start \"playPhase\"\n    preloadPhase(canvas, script, playSink.$messages).then(playSink.start);\n\n    return playSink;\n}\n\n","import scriptPreloader from './task/sequencer/scriptPreloader';\nimport fastdom from 'fastdom';\n\nexport default preloadPhase;\n\nfunction preloadPhase(canvas, script, $messages){\n    var preloader = scriptPreloader(script, script.settings.base_url);\n\n    if (preloader.progress() == 1) return Promise.resolve().then(emptyCanvas);\n\n    canvas.innerHTML = '<div class=\"minno-progress\"><div class=\"minno-progress-bar\"></div></div>';\n\n    var barStyle = canvas.getElementsByClassName('minno-progress-bar')[0].style;\n    barStyle.width = preloader.progress() + '%';\n    preloader.onload = function(){\n        fastdom.mutate(function(){\n            barStyle.width = preloader.progress()*100 + '%';\n        });\n    };\n    preloader.onerror = function(e, src){\n        $messages({\n            type:'error',\n            message: 'Failed to preload',\n            error:e,\n            context:src\n        });\n    };\n\n    return preloader.all()\n        .then(emptyCanvas)['catch'](function(src){\n            throw new Error('loading resource failed, do something about it! (you can start by checking the error log, you are probably reffering to the wrong url - ' + src +')');\n        });\n\n    function emptyCanvas(){\n        while (canvas.firstChild) canvas.removeChild(canvas.firstChild);\n    }\n}\n\n"],"names":["log","console","apply","arguments","w","perfNow","perfNowNames","i","length","n","Date","now","window","group","groupCollapsed","groupEnd","table","lastTime","vendors","requestAnimationFrame","vp","cancelAnimationFrame","test","navigator","userAgent","callback","nextTime","Math","max","setTimeout","clearTimeout","Element","prototype","matches","msMatchesSelector","webkitMatchesSelector","closest","s","el","this","call","parentElement","parentNode","nodeType","glob","piGlobal","go","destination","properties","context","mixerSequence","where","prev","current","next","Error","direction","sequence","curr","_","iteratee","data","win","debug","raf","webkitRequestAnimationFrame","mozRequestAnimationFrame","msRequestAnimationFrame","cb","FastDom","reads","writes","bind","scheduleFlush","fastdom","scheduled","error","runTasks","e","message","catch","remove","array","item","index","indexOf","splice","constructor","tasks","task","shift","measure","fn","ctx","push","mutate","clear","extend","props","child","Object","create","target","source","key","hasOwnProperty","mixin","initialize","exports","module","parse","num","parseFloat","adjust_canvas","canvas","settings","$messages","throttle","event","type","resize","targetSize","proportions","isNumeric","isPlainObject","height","width","every","getProportions","maWidth","maxWidth","docElement","document","documentElement","maxHeight","clientHeight","min","Infinity","clientWidth","computedStyle","getComputedStyle","offsetHeight","borderTopWidth","borderBottomWidth","offsetWidth","borderLeftWidth","borderRightWidth","getSize","getTargetSize","marginTop","style","fontSize","textSize","scrollTo","isNaN","isFinite","canvasContructor","map","offArr","isUndefined","noop","value","property","old","rule","element","forEach","createStream","stream","HALT","updateStream","_state","id","guid","undefined","state","derive","recover","deps","parents","endStream","unregister","ap","valueOf","toJSON","toString","defineProperties","end","get","unregisterStream","updateState","updateDependency","changed","finalize","mustSync","active","some","combine","streams","valid","dep","concat","filter","notEnded","registerDependency","dependent","s1","s2","merge","scan","reducer","seed","newStream","scanMerge","tuples","tuple","idx","obj","str","replace","g","toUpperCase","camelCase","setup","script","name","$resize","canvasSettings","isElement","classList","add","off","applyCanvasStyles","background","body","canvasBackground","borderColor","borderWidth","pick","css","adjustCanvas","addEventListener","removeEventListener","canvasSetup","db","Database","createColl","trialSets","stimulusSets","mediaSets","isArray","currentSequence","createDB","logs","srcStack","defStack","stackDone","getText","memoize","url","Promise","resolve","reject","request","XMLHttpRequest","open","onreadystatechange","readyState","status","responseText","send","loader","load","src","promise","includes","createElement","onload","onerror","then","all","progress","buildUrl","baseUrl","isObject","preloadScript","getStimMedia","getTrialMedia","notMixer","preload","image","flattenDeep","notUndefined","media","preloader","template","trial","input","stimuli","layout","stim","mixer","val","mouseEvents","eventName","inputObj","$listener","appendChild","contains","stimHandle","removeChild","keyDownArr","keypressed","Array","charCodeAt","keypressListener","which","preventDefault","keyup","a","b","itterations","results","performance","offset","timeout","duration","floor","random","isFunction","isNumber","randomize","isCanceled","step","update","arr","reduce","v","createListener","isString","on","assign","position","left","opacity","right","top","bottom","css2","css1","binder","getListener","JSON","stringify","handle","interfaceFn","$events","listenerStack","baseTime","timestamp","latency","removeAll","resetTimer","getMedia","html","inlineTemplate","p","isThenable","customMedia","isWord","word","textContent","innerHTML","$image","startTime","jquery","setSize","stimulus","size","font_size","setPlace","location","attr","isIE","documentMode","setupElement","testProps","p1","p2","setAttribute","zIndex","isLayout","init","show","hide","destroy","alias","inherit","set","mediaName","options","prop","fullpath","stimCollection","validateStimuli","_source","toStim","stimReady","ready","getStimlist","getMedialist","self","nolog","global","conditionHash","begin","inputData","inputEquals","condition","inputEqualsTrial","inputEqualsStim","searchObj","hasData","trialEquals","inputEqualsGlobal","globalEquals","globalEqualsTrial","globalProp","trialProp","globalEqualsStim","stimProp","currentEquals","currentEqualsTrial","currentProp","currentEqualsStim","inputEqualsCurrent","custom","stimulusCollection","conditionsEvaluate","conditions","getConditionFn","negate","actions","showStim","action","eventData","hideStim","setStimAttr","setter","setTrialAttr","setInput","trigger","removeInput","handleList","goto","_next","endTrial","reset","immidiate","$logs","setGlobalAttr","cavnas","$end","startMouseTracking","listener","$message","logAs","styling","topBorder","parseInt","getPropertyValue","leftBorder","trackedStimuli","logStimulusLocation","canvasLocation","getBoundingClientRect","correctedCanvas","x","y","mouseLocation","mouseX","clientX","mouseY","clientY","locations","acc","rect","mapValues","round","logRate","stopMouseTracking","ed","interactions","recursionDepth","isValidProp","interaction","validateInteractions","conditionTrue","groupName","debugLog","evaluate","actionFn","actionList","activate","rows","gid","Trial","_id","uniqueId","counter","transformLogs","trialData","logStack","stimList","mediaList","log_serial","trial_id","responseHandle","playerPhase","sink","cache","$sourceLogs","loggerSettings","kill","$source","$trial","oldTrial","DEBUG","trialName","row","setupDebug","play","start","metaData","taskName","$meta","defaultLogMap","logMap","logger","args","onDone","onEnd","skip","clone","trialMeta","buildStim","done","buildMedia","inflate","base_url","requirejs","mediaData","mediaMeta","stimulusData","stimulusMeta","trialId","playSink","playPhase","scriptPreloader","emptyCanvas","barStyle","getElementsByClassName","firstChild","preloadPhase"],"mappings":"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"}